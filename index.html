<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#991b1b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Sistema Vida - Alimento Di√°rio</title>
    
    <!-- Bibliotecas Essenciais -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- Fontes -->
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,300;0,400;0,700;1,400&family=Press+Start+2P&family=Inter:wght@400;600;700&family=Poppins:wght@300;400;600;800&family=Lora:ital,wght@0,400;1,400&family=Dancing+Script:wght@600&family=Montserrat:wght@400;700&family=Bebas+Neue&family=Permanent+Marker&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- ESTILOS GERAIS --- */
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; background-color: #f3f4f6; }
        .font-serif { font-family: 'Merriweather', serif; }
        .font-handwriting { font-family: 'Courier New', Courier, monospace; }
        .font-arcade { font-family: 'Press Start 2P', cursive; }
        .font-inter { font-family: 'Inter', sans-serif; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.5s ease-out forwards; }
        
        @keyframes bounce-subtle { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        .animate-bounce-subtle { animation: bounce-subtle 2s infinite ease-in-out; }
        
        /* Anima√ß√£o das barras de √°udio */
        @keyframes sound-bar { 0% { height: 10%; } 50% { height: 100%; } 100% { height: 10%; } }
        .sound-bar { width: 6px; background-color: #FCD34D; border-radius: 99px; animation: sound-bar 0.8s infinite ease-in-out; }
        .sound-bar:nth-child(1) { animation-delay: 0.1s; } .sound-bar:nth-child(2) { animation-delay: 0.3s; } .sound-bar:nth-child(3) { animation-delay: 0.5s; }

        /* Jogo da Mem√≥ria */
        .memory-card { perspective: 1000px; cursor: pointer; }
        .memory-card-inner { position: relative; width: 100%; height: 100%; transition: transform 0.6s; transform-style: preserve-3d; border-radius: 0.5rem; }
        .memory-card.is-flipped .memory-card-inner { transform: rotateY(180deg); }
        .memory-card-front, .memory-card-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 0.5rem; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .memory-card-back { background-color: #3B82F6; color: white; font-size: 1.5rem; transform: rotateY(0deg); }
        .memory-card-front { background-color: #E5E7EB; color: #1F2937; font-size: 2rem; transform: rotateY(180deg); }

        /* Forca */
        .hangman-part { transition: opacity 0.5s ease-in-out, stroke 0.3s; stroke: #374151; stroke-width: 4; stroke-linecap: round; }
        .hangman-part-error { stroke: #ef4444; }

        @media print {
            .no-print { display: none !important; }
            body * { visibility: hidden; }
            #printable-area, #printable-area * { visibility: visible; }
            #printable-area { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; background: white; }
        }

        /* --- ESTILOS DO EST√öDIO CLEAN EDITION (V31.1) --- */
        .studio-wrapper {
            --primary: #e11d48; --primary-light: #ffebf0;
            --bg-body: #f4f6f9; --bg-card: #ffffff; 
            --text-main: #1e293b; --text-sec: #64748b;
            --border: #e2e8f0; --input-bg: #f8fafc; 
            --shadow: 0 10px 40px -10px rgba(0,0,0,0.08);
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }
        .studio-wrapper[data-theme="dark"] { 
            --primary: #fb7185; --primary-light: #2d1b20;
            --bg-body: #0f172a; --bg-card: #1e293b; 
            --text-main: #f1f5f9; --text-sec: #94a3b8;
            --border: #334155; --input-bg: #334155; 
            --shadow: 0 10px 40px -10px rgba(0,0,0,0.5);
        }

        /* Particles */
        .studio-particles { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none; overflow: hidden; }
        .particle { position: absolute; background: var(--primary); border-radius: 50%; opacity: 0.2; animation: floatUp linear infinite; }
        @keyframes floatUp { 0% { transform: translateY(100vh) scale(0); opacity: 0; } 50% { opacity: 0.5; } 100% { transform: translateY(-10vh) scale(1); opacity: 0; } }

        /* Header Studio */
        .studio-header { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(20px); padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); position: relative; z-index: 10; }
        .studio-wrapper[data-theme="dark"] .studio-header { background: rgba(15, 23, 42, 0.8); }
        
        .streak-badge { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; display: flex; align-items: center; gap: 6px; box-shadow: 0 4px 10px rgba(245, 158, 11, 0.3); cursor: pointer; transition: transform 0.2s; }
        .streak-badge:active { transform: scale(0.95); }

        .studio-container { padding: 20px; max-width: 600px; margin: 0 auto; position: relative; z-index: 5; padding-bottom: 120px; }
        
        /* Tools Section */
        .tools-section { background: var(--bg-card); padding: 20px; border-radius: 24px; border: 1px solid var(--border); margin-bottom: 20px; box-shadow: var(--shadow); position: relative; z-index: 1; }
        .section-title { font-size: 0.8rem; font-weight: 700; color: var(--text-sec); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }

        .search-row { display: flex; gap: 10px; margin-bottom: 15px; position: relative; }
        .search-icon { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: var(--text-sec); opacity: 0.5; }
        .search-input { flex: 1; padding: 14px 14px 14px 40px; border-radius: 16px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-main); outline: none; transition: 0.3s; margin-bottom: 0; }
        .track-input { width: 100%; padding: 16px; border-radius: 18px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-main); font-size: 1rem; outline: none; margin-top: 5px; }
        
        .btn-magic { background: linear-gradient(135deg, var(--primary), #db2777); color: white; border: none; width: 54px; border-radius: 16px; cursor: pointer; font-size: 1.2rem; box-shadow: 0 4px 15px rgba(225, 29, 72, 0.3); transition: 0.2s; display: flex; align-items: center; justify-content: center; }
        
        /* Card Preview Styles */
        .preview-container-3d { perspective: 1000px; width: 100%; display: flex; justify-content: center; margin-bottom: 25px; margin-top: 20px; }
        .card-preview-wrapper { width: 100%; aspect-ratio: 4/5; border-radius: 32px; text-align: center; position: relative; overflow: hidden; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 40px; background-color: white; box-shadow: 0 20px 60px -10px rgba(0,0,0,0.25); transform-style: preserve-3d; transition: transform 0.1s ease-out; border: 1px solid rgba(255,255,255,0.2); }
        
        .card-overlay { position: absolute; top:0; left:0; width:100%; height:100%; z-index: 1; pointer-events: none; transition: 0.3s; transform: translateZ(0); }
        .dimmer-light { background: rgba(0,0,0,0.2); }
        .dimmer-heavy { background: rgba(0,0,0,0.5); }
        
        .card-content-layer { position: relative; z-index: 5; width: 100%; transform: translateZ(30px); text-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .pv-title { font-size: 1.8rem; font-weight: 800; margin-bottom: 12px; line-height: 1.1; letter-spacing: -0.5px; }
        .pv-ref { font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; opacity: 0.8; margin-bottom: 6px; font-weight: 600; }
        .pv-verse { font-style: italic; opacity: 0.9; margin-bottom: 15px; display: block; font-size: 0.9em; }
        .pv-msg { padding: 30px; border-radius: 24px; font-size: 0.95rem; line-height: 1.7; margin-bottom: 30px; background: rgba(255,255,255,0.9); backdrop-filter: blur(15px); color: #333; min-height: 100px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); transition: 0.3s; }
        .pv-footer { font-size: 0.7rem; opacity: 0.75; text-transform: uppercase; margin-top: auto; display: flex; align-items: center; justify-content: center; gap: 6px; font-weight: 600; letter-spacing: 0.5px; }
        
        /* CURSOR BLINK (M√°quina de Escrever) */
        .cursor-blink { display: inline-block; width: 2px; height: 1em; background-color: currentColor; margin-left: 2px; animation: blink 1s step-end infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }

        .card-sticker { position: absolute; top: 25px; right: 25px; z-index: 10; background: rgba(255,255,255,0.95); padding: 8px 16px; border-radius: 30px; font-size: 0.75rem; font-weight: 800; color: var(--primary); text-transform: uppercase; letter-spacing: 1px; box-shadow: 0 8px 20px rgba(0,0,0,0.15); display: none; backdrop-filter: blur(5px); transform: translateZ(20px); }
        .card-sticker.visible { display: block; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* Draggable */
        .draggable-item { cursor: grab; touch-action: none; position: relative; z-index: 10; user-select: none; transition: transform 0.05s linear; }
        .draggable-item:active { cursor: grabbing; z-index: 50; }

        /* Formatos */
        .fmt-feed { aspect-ratio: 4/5; border-radius: 28px; }
        .fmt-square { aspect-ratio: 1/1; border-radius: 28px; }
        .fmt-story { aspect-ratio: 9/16; border-radius: 0; }
        .fmt-music { aspect-ratio: 4/5; border-radius: 24px; }

        /* Frames */
        .frame-white { border: 12px solid #ffffff; }
        .frame-black { border: 12px solid #1e293b; }
        .frame-gold { border: 12px solid #d4af37; box-shadow: inset 0 0 20px rgba(184, 134, 11, 0.5); }
        .frame-wood { border: 15px solid #8b4513; border-radius: 4px !important; }
        .frame-neon-pink { border: 4px solid #ff00ff; box-shadow: 0 0 15px #ff00ff, inset 0 0 15px #ff00ff; }
        .frame-neon-blue { border: 4px solid #00ffff; box-shadow: 0 0 15px #00ffff, inset 0 0 15px #00ffff; }
        .frame-double { border: 8px solid white; outline: 4px solid rgba(0,0,0,0.1); outline-offset: -14px; }
        .frame-modern-y { border-top: 20px solid var(--primary); border-bottom: 20px solid var(--primary); }
        .frame-modern-x { border-left: 20px solid var(--primary); border-right: 20px solid var(--primary); }
        .frame-polaroid-clean { border: 15px solid white; border-bottom-width: 50px; border-radius: 2px !important; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        
        /* Bottom Nav Studio */
        .studio-bottom-nav { position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%); width: 85%; max-width: 380px; height: 70px; background: rgba(30, 41, 59, 0.85); backdrop-filter: blur(20px); border-radius: 40px; display: flex; justify-content: space-around; align-items: center; z-index: 1000; box-shadow: 0 15px 40px rgba(0,0,0,0.3); }
        .studio-nav-item { background: none; border: none; color: rgba(255,255,255,0.4); font-size: 1.3rem; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: 0.3s; }
        .studio-nav-item.active { background: var(--primary); color: white; transform: translateY(-5px); box-shadow: 0 8px 20px rgba(225, 29, 72, 0.4); }

        /* Helpers */
        .cat-scroll { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 15px; scrollbar-width: none; }
        .cat-chip { background: var(--input-bg); padding: 8px 16px; border-radius: 20px; font-size: 0.8rem; white-space: nowrap; cursor: pointer; border: 1px solid var(--border); font-weight: 600; color: var(--text-sec); }
        .cat-chip:hover { background: var(--primary); color: white; border-color: var(--primary); }

        .format-bar { display: flex; gap: 8px; justify-content: center; margin-bottom: 15px; background: var(--bg-card); padding: 6px; border-radius: 20px; border: 1px solid var(--border); box-shadow: var(--shadow); }
        .fmt-btn { flex: 1; padding: 10px; border-radius: 14px; background: transparent; color: var(--text-sec); font-size: 0.8rem; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; transition: 0.2s; }
        .fmt-btn.active { background: var(--text-main); color: var(--bg-body); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }

        /* Themes & Colors */
        .t-clean { background: white; color: #1e293b; } .t-clean .pv-title { color: #e11d48; }
        .t-dark { background: #0f172a; color: white; } .t-dark .pv-msg { background: rgba(255,255,255,0.1); color: #e2e8f0; border: 1px solid rgba(255,255,255,0.1); } .t-dark .pv-title { color: #818cf8; }
        .t-gold { background: linear-gradient(135deg, #FDEB71 0%, #F8D800 100%); color: #5c4a08; } .t-gold .pv-msg { background: rgba(255,255,255,0.6); color: #423602; }
        .t-ocean { background: linear-gradient(to top, #30cfd0 0%, #330867 100%); color: white; } .t-ocean .pv-msg { background: rgba(255,255,255,0.15); color:white; border: 1px solid rgba(255,255,255,0.2); }
        .t-nature { background: linear-gradient(120deg, #d4fc79 0%, #96e6a1 100%); color: #14532d; } .t-nature .pv-msg { background: rgba(255,255,255,0.7); }
        .t-sunset { background: linear-gradient(to right, #fa709a 0%, #fee140 100%); color: #7f1d1d; } .t-sunset .pv-msg { background: rgba(255,255,255,0.8); }
        .t-royal { background: linear-gradient(to right, #6a11cb 0%, #2575fc 100%); color: white; } .t-royal .pv-msg { background: rgba(255,255,255,0.15); color:white; border: 1px solid rgba(255,255,255,0.2); }
        .t-berry { background: linear-gradient(to top, #f43b47 0%, #453a94 100%); color: white; } .t-berry .pv-msg { background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.2); }
        .t-mint { background: linear-gradient(120deg, #84fab0 0%, #8fd3f4 100%); color: #0f766e; } .t-mint .pv-msg { background: rgba(255,255,255,0.6); }

        /* Fontes Studio */
        .font-modern .pv-title { font-family: 'Poppins', sans-serif; } 
        .font-classic .pv-title { font-family: 'Playfair Display', serif; } 
        .font-hand .pv-title { font-family: 'Dancing Script', cursive; font-size: 2.6rem; }
        .font-bold .pv-title { font-family: 'Bebas Neue', sans-serif; font-size: 3.5rem; letter-spacing: 1px; }
        .font-marker .pv-title { font-family: 'Permanent Marker', cursive; font-size: 2.2rem; }

        /* Actions Grid */
        .actions-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .btn-action { border: none; padding: 18px; border-radius: 18px; font-weight: 600; color: white; display: flex; align-items: center; justify-content: center; gap: 10px; cursor: pointer; transition: 0.2s; font-size: 1rem; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .btn-share { background: #25D366; grid-column: span 2; }
        .btn-audio { background: #f43f5e; color: white; grid-column: span 2; }
        .btn-save { background: #3b82f6; } .btn-print { background: #64748b; } .btn-copy { background: #94a3b8; }

        /* Slider Box */
        .slider-box { background: var(--bg-card); border: 1px solid var(--border); border-radius: 20px; padding: 15px; margin-bottom: 20px; display: flex; flex-direction: column; gap: 15px; box-shadow: var(--shadow); }
        .slider-row { display: flex; gap: 15px; }
        .slider-wrapper { flex: 1; display: flex; flex-direction: column; gap: 8px; }
        .slider-label { font-size: 0.65rem; font-weight: 800; color: var(--text-sec); text-transform: uppercase; }
        input[type=range] { width: 100%; -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 18px; width: 18px; border-radius: 50%; background: var(--primary); cursor: pointer; margin-top: -7px; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: var(--border); border-radius: 2px; }

        /* Music Overlay */
        .music-overlay { position: absolute; bottom: 20px; left: 0; width: 100%; padding: 0 30px; z-index: 8; display: none; flex-direction: column; gap: 8px; transform: translateZ(10px); }
        .fmt-music .music-overlay { display: flex; }
        .fmt-music .pv-footer { display: none; }
        .music-bar { width: 100%; height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px; }
        .music-progress { width: 65%; height: 100%; background: white; border-radius: 2px; }
        .music-time { display: flex; justify-content: space-between; font-size: 0.6rem; color: rgba(255,255,255,0.8); font-weight: 600; margin-top: 4px; font-family: 'Montserrat', sans-serif; }
        .music-controls { display: flex; justify-content: center; gap: 20px; align-items: center; margin-top: 5px; color: white; font-size: 1.2rem; }

        /* Emoji Grid */
        .emoji-grid { display: none; grid-template-columns: repeat(8, 1fr); gap: 5px; background: var(--bg-card); padding: 10px; border-radius: 16px; border: 1px solid var(--border); margin-top: 10px; max-height: 180px; overflow-y: auto; }
        .emoji-grid.show { display: grid; }
        .emoji-item { font-size: 1.5rem; cursor: pointer; padding: 6px; text-align: center; border-radius: 8px; }
        .emoji-item:hover { background: var(--input-bg); transform: scale(1.2); }

        /* Scroll Tools */
        .scroll-tools { display: flex; flex-direction: column; gap: 12px; margin-bottom: 25px; }
        .tool-row { display: flex; gap: 10px; overflow-x: auto; scrollbar-width: none; padding: 4px 2px 10px 2px; white-space: nowrap; }
        .tool-btn { flex: 0 0 auto; padding: 10px 18px; border-radius: 14px; border: 1px solid var(--border); background: var(--bg-card); color: var(--text-sec); font-size: 0.85rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
        .tool-btn:active { transform: scale(0.95); }
        .tool-btn.active { background: var(--primary-light); color: var(--primary); border-color: var(--primary); box-shadow: 0 4px 10px rgba(225, 29, 72, 0.15); }

        .preview-controls { display: flex; flex-direction: row; flex-wrap: nowrap; gap: 14px; overflow-x: auto; align-items: center; scrollbar-width: none; padding: 10px 5px 25px 5px; margin-bottom: 0; }
        .theme-btn { flex: 0 0 auto; width: 60px; height: 60px; border-radius: 18px; border: 3px solid transparent; cursor: pointer; position: relative; background-size: cover; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; color: rgba(255,255,255,0.9); box-shadow: 0 5px 15px rgba(0,0,0,0.1); transition: 0.3s; }
        .theme-btn:hover { transform: translateY(-3px); }
        .theme-btn.active { border-color: var(--primary); transform: scale(1.1); box-shadow: 0 10px 25px rgba(225, 29, 72, 0.3); z-index: 10; }
        .theme-btn.upload-btn { border: 2px dashed var(--text-sec); color: var(--text-sec); box-shadow: none; background: var(--input-bg); }
        .theme-btn.magic-btn { background: linear-gradient(135deg, #a855f7, #ec4899); color: white; border: none; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900">
    <div id="root"></div>

    <!-- FUN√á√ïES GLOBAIS (FORA DO BABEL PARA EVITAR ERROS) -->
    <script>
        window.formatarEMV = function(id, value) { const length = ('00' + value.length).slice(-2); return id + length + value; };
        window.simplificarTexto = function(text) { return text.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^\w\s]/g, ''); };
        window.crc16 = function(data) { let crc = 0xFFFF; for (let i = 0; i < data.length; i++) { crc ^= data.charCodeAt(i) << 8; for (let j = 0; j < 8; j++) { crc = (crc & 0x8000) ? (crc << 1) ^ 0x1021 : crc << 1; } } return ('0000' + (crc & 0xFFFF).toString(16).toUpperCase()).slice(-4); };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef, Component, useMemo } = React;

        // --- GLOBAL CONSTANTS (DEFINI√á√ïES DE DADOS GLOBAIS) ---
        // Definir aqui para estarem acess√≠veis a todos os componentes
        const HANGMAN_CATEGORIES = {
            'B√çBLICO': ['GOLIAS', 'MOISES', 'ABRAAO', 'SAMUEL', 'SALOMAO', 'MATEUS', 'GABRIEL', 'JERUSALEM', 'GENESIS', 'PENTATEUCO', 'TABERNACULO', 'ARCA', 'SINAI', 'EGITO', 'MANA', 'JORDANIA', 'JERICO', 'DANIEL', 'ESTRELA', 'BETANIA'],
            'FRUTAS': ['MELANCIA', 'ABACAXI', 'BANANA', 'MORANGO', 'LARANJA', 'UVA', 'MANGA', 'PERA', 'ABACATE', 'PITAYA', 'TAMARINDO', 'CEREJA', 'GOIABA'],
            'ANIMAIS': ['CACHORRO', 'GIRAFA', 'ELEFANTE', 'LEAO', 'MACACO', 'TIGRE', 'ZEBRA', 'COELHO', 'GATO', 'ORNITORRINCO', 'CANGURU', 'ESCORPIAO'],
            'PA√çSES': ['PORTUGAL', 'BRASIL', 'ARGENTINA', 'CANADA', 'JAPAO', 'ITALIA', 'FRAN√áA', 'CHINA', 'EGITO', 'ANGOLA', 'MO√áAMBIQUE', 'GRECIA']
        };

        const bibleQuizDatabase = [
            { question: "Quem construiu a arca?", options: ["Mois√©s", "No√©", "Abra√£o", "Davi"], answer: 1 },
            { question: "Qual √© o primeiro livro da B√≠blia?", options: ["Mateus", "Apocalipse", "G√™nesis", "√äxodo"], answer: 2 },
            { question: "Quem derrotou o gigante Golias?", options: ["Davi", "Saul", "Salom√£o", "Sans√£o"], answer: 0 },
            { question: "Onde Jesus nasceu?", options: ["Nazar√©", "Jerusal√©m", "Bel√©m", "Galileia"], answer: 2 },
            { question: "Quem foi engolido por um grande peixe?", options: ["Pedro", "Jonas", "Paulo", "Jo√£o"], answer: 1 },
            { question: "Qual o nome da esposa de Abra√£o?", options: ["Raquel", "Rebeca", "Sara", "Lia"], answer: 2 },
            { question: "Quantos mandamentos Deus deu a Mois√©s?", options: ["5", "7", "10", "12"], answer: 2 },
            { question: "Quem traiu Jesus?", options: ["Pedro", "Judas iScariotes", "Tiago", "Tom√©"], answer: 1 },
            { question: "Quem abriu o Mar Vermelho?", options: ["Elias", "Mois√©s", "Josu√©", "Ar√£o"], answer: 1 },
            { question: "Qual profeta foi levado ao c√©u numa carruagem de fogo?", options: ["Elias", "Eliseu", "Isa√≠as", "Jeremias"], answer: 0 }
        ];

        const preachingDatabase = [
            { 
                ref: "Jo√£o 3:16", 
                theme: "O Amor Incompar√°vel de Deus", 
                intro: "Este vers√≠culo √© o cora√ß√£o do Evangelho, revelando a motiva√ß√£o m√°xima de Deus: o Amor.",
                points: [
                    "A Origem do Amor: Tudo come√ßa em Deus.",
                    "A Extens√£o do Amor: 'Amou o mundo de tal maneira'.",
                    "O Sacrif√≠cio do Amor: Entregou o Seu √∫nico Filho.",
                    "O Objetivo do Amor: Vida eterna para todo aquele que cr√™."
                ],
                conclusion: "O amor de Deus exige uma resposta de f√©. Aceite este presente hoje."
            },
            { 
                ref: "Salmos 23:1", 
                theme: "O Senhor √© o meu Pastor", 
                intro: "Davi descreve a sufici√™ncia de Deus em todas as fases da vida.",
                points: [
                    "Relacionamento Pessoal: 'O Senhor √© o MEU pastor'.",
                    "Provis√£o Plena: 'Nada me faltar√°'.",
                    "Descanso e Refrig√©rio: √Åguas tranquilas e pastos verdejantes.",
                    "Seguran√ßa na Crise: 'Ainda que eu andasse pelo vale da morte'."
                ],
                conclusion: "Sob o cuidado do Bom Pastor, a nossa jornada est√° segura."
            },
            { 
                ref: "Filipenses 4:13", 
                theme: "A Fonte da Nossa For√ßa", 
                intro: "Paulo escreve sobre o contentamento e a for√ßa que vem de Cristo, mesmo na pris√£o.",
                points: [
                    "A Depend√™ncia Correta: N√£o √© auto-ajuda, √© ajuda do alto.",
                    "A Capacidade em Cristo: 'Tudo posso'.",
                    "O Fortalecedor: A presen√ßa constante de Jesus.",
                    "Superando Circunst√¢ncias: For√ßa para abund√¢ncia ou escassez."
                ],
                conclusion: "A nossa vit√≥ria n√£o depende das circunst√¢ncias, mas de Quem nos fortalece."
            }
        ];

        const NAV_ITEMS = [
            { id: 'home', label: 'In√≠cio', icon: 'home' },
            { id: 'bible', label: 'B√≠blia', icon: 'book-open' },
            { id: 'names', label: 'Nomes', icon: 'user' },
            { id: 'preaching', label: 'Prega√ß√£o', icon: 'megaphone' },
            { id: 'games', label: 'Jogos', icon: 'gamepad-2' },
            { id: 'studio', label: 'Est√∫dio', icon: 'magic' }, 
            { id: 'qrcode', label: 'QR Code', icon: 'qr-code' },
            { id: 'radio', label: 'R√°dio', icon: 'radio' },
            { id: 'notes', label: 'Di√°rio', icon: 'calendar' },
            { id: 'financial', label: 'Financeiro', icon: 'dollar-sign' }
        ];

        const nameDatabase = { 
            "ana": "Cheia de gra√ßa e compaix√£o.", 
            "maria": "Soberana, senhora ou pura.", 
            "jo√£o": "Deus √© misericordioso.",
            "pedro": "Rocha ou pedra.",
            "paulo": "Pequeno ou humilde.",
            "lucas": "Luminoso ou iluminado."
        };
        
        const bibleBooks = ["G√™nesis", "√äxodo", "Lev√≠tico", "N√∫meros", "Deuteron√¥mio", "Josu√©", "Ju√≠zes", "Rute", "1 Samuel", "2 Samuel", "1 Reis", "2 Reis", "1 Cr√¥nicas", "2 Cr√¥nicas", "Esdras", "Neemias", "Ester", "J√≥", "Salmos", "Prov√©rbios", "Eclesiastes", "C√¢nticos", "Isa√≠as", "Jeremias", "Lamenta√ß√µes", "Ezequiel", "Daniel", "Oseias", "Joel", "Am√≥s", "Obadias", "Jonas", "Miqueias", "Naum", "Habacuque", "Sofonias", "Ageu", "Zacarias", "Malaquias", "Mateus", "Marcos", "Lucas", "Jo√£o", "Atos", "Romanos", "1 Cor√≠ntios", "2 Cor√≠ntios", "G√°latas", "Ef√©sios", "Filipenses", "Colossenses", "1 Tessalonicenses", "2 Tessalonicenses", "1 Tim√≥teo", "2 Tim√≥teo", "Tito", "Filemom", "Hebreus", "Tiago", "1 Pedro", "2 Pedro", "1 Jo√£o", "2 Jo√£o", "3 Jo√£o", "Judas", "Apocalipse"];

        // --- ERROR BOUNDARY ---
        class ErrorBoundary extends Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false };
            }
            static getDerivedStateFromError(error) { return { hasError: true }; }
            render() {
                if (this.state.hasError) return (
                    <div className="min-h-screen flex items-center justify-center bg-red-50 p-4">
                        <div className="text-center">
                            <h1 className="text-red-800 text-xl font-bold mb-2">Ops! Algo correu mal.</h1>
                            <p className="text-red-600 mb-4">Tente recarregar a p√°gina.</p>
                            <button onClick={()=>window.location.reload()} className="bg-red-700 text-white px-6 py-2 rounded-full font-bold shadow hover:bg-red-800 transition-transform active:scale-95">Recarregar</button>
                            <button onClick={()=>{localStorage.clear(); window.location.reload()}} className="block mx-auto mt-4 text-xs text-gray-400 underline">Limpar Dados e Recarregar</button>
                        </div>
                    </div>
                );
                return this.props.children;
            }
        }
        
        // --- PERSIST√äNCIA SEGURA ---
        function usePersistentState(key, initialValue) {
            const [state, setState] = useState(() => {
                try {
                    const item = localStorage.getItem(key);
                    return item ? JSON.parse(item) : initialValue;
                } catch (error) {
                    console.warn(`Erro ao carregar ${key} do localStorage:`, error);
                    return initialValue;
                }
            });
            
            useEffect(() => {
                try {
                    localStorage.setItem(key, JSON.stringify(state));
                } catch (error) {
                    console.error(`Erro ao salvar ${key}:`, error);
                }
            }, [key, state]);
            
            return [state, setState];
        }

        // --- SONS ---
        const playSoundEffect = (type) => {
            try {
                if(typeof Tone === 'undefined') return;
                const now = Tone.now();
                if (type === 'correct' || type === 'quiz_correct' || type === 'hangman_correct') {
                    const synth = new Tone.Synth({ oscillator: { type: 'triangle' } }).toDestination();
                    synth.triggerAttackRelease('E5', '16n', now);
                } else if (type === 'wrong' || type === 'quiz_wrong' || type === 'hangman_wrong') {
                    const synth = new Tone.Synth({ oscillator: { type: 'square' } }).toDestination();
                    synth.triggerAttackRelease('A2', '8n', now);
                } else if (type === 'win') {
                    const synth = new Tone.PolySynth(Tone.Synth).toDestination();
                    synth.triggerAttackRelease(["C4", "E4", "G4", "C5"], "4n");
                } else if (type === 'lose') {
                    const synth = new Tone.Synth().toDestination();
                    synth.triggerAttackRelease('C3', '4n', now);
                }
            } catch (e) { console.log("√Åudio indispon√≠vel"); }
        };

        // --- √çCONES ---
        const icons = {
            'home': <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />,
            'book-open': <><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></>,
            'user': <><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2" /><circle cx="12" cy="7" r="4" /></>,
            'gamepad-2': <><line x1="6" x2="10" y1="12" y2="12" /><line x1="8" x2="8" y1="10" y2="14" /><line x1="15" x2="15.01" y1="13" y2="13" /><line x1="18" x2="18.01" y1="11" y2="11" /><rect width="20" height="12" x="2" y="6" rx="2" /></>,
            'qr-code': <><rect width="5" height="5" x="3" y="3" rx="1" /><rect width="5" height="5" x="16" y="3" rx="1" /><rect width="5" height="5" x="3" y="16" rx="1" /><path d="M21 16h-3a2 2 0 0 0-2 2v3" /><path d="M21 21v.01" /><path d="M12 7v3a2 2 0 0 1-2 2H7" /><path d="M3 12h.01" /><path d="M12 3h.01" /><path d="M12 16v.01" /><path d="M16 12h1" /><path d="M21 12v.01" /><path d="M12 21v-1" /></>,
            'radio': <><circle cx="12" cy="12" r="2" /><path d="M16.24 7.76a6 6 0 0 1 0 8.49" /><path d="M19.07 4.93a10 10 0 0 1 0 14.14" /></>,
            'calendar': <><rect x="3" y="4" width="18" height="18" rx="2" ry="2" /><line x1="16" y1="2" x2="16" y2="6" /><line x1="8" y1="2" x2="8" y2="6" /><line x1="3" y1="10" x2="21" y2="10" /></>,
            'megaphone': <><path d="m3 11 18-5v12L3 14v-3z" /><path d="M11.6 16.8a3 3 0 1 1-5.8-1.6" /></>,
            'menu': <><line x1="4" x2="20" y1="12" y2="12" /><line x1="4" x2="20" y1="6" y2="6" /><line x1="4" x2="20" y1="18" y2="18" /></>,
            'arrow-left': <><line x1="19" y1="12" x2="5" y2="12" /><polyline points="12 19 5 12 12 5" /></>,
            'chevron-left': <path d="m15 18-6-6 6-6" />,
            'chevron-right': <path d="m9 18 6-6-6-6" />,
            'check-circle': <><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" /><polyline points="22 4 12 14.01 9 11.01" /></>,
            'volume-2': <><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5" /><path d="M19.07 4.93a10 10 0 0 1 0 14.14" /><path d="M15.54 8.46a5 5 0 0 1 0 7.07" /></>,
            'square': <rect width="18" height="18" x="3" y="3" rx="2" />,
            'refresh-cw': <><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8" /><path d="M21 3v5h-5" /><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16" /><path d="M8 16H3v5" /></>,
            'copy': <><rect x="9" y="9" width="13" height="13" rx="2" ry="2" /><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" /></>,
            'zap': <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" />,
            'help-circle': <><circle cx="12" cy="12" r="10" /><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3" /><line x1="12" y1="17" x2="12.01" y2="17" /></>,
            'search': <><circle cx="11" cy="11" r="8" /><path d="m21 21-4.3-4.3" /></>,
            'download': <><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="7 10 12 15 17 10" /><line x1="12" x2="12" y1="15" y2="3" /></>,
            'trash-2': <><polyline points="3 6 5 6 21 6" /><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" /><line x1="10" y1="11" x2="10" y2="17" /><line x1="14" y1="11" x2="14" y2="17" /></>,
            'magic': <path d="m19 14 3-6-6-3" />,
            'dollar-sign': <><line x1="12" x2="12" y1="2" y2="22" /><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" /></>,
            'trending-up': <><polyline points="23 6 13.5 15.5 8.5 10.5 1 18" /><polyline points="17 6 23 6 23 12" /></>,
            'credit-card': <><rect x="1" y="4" width="22" height="16" rx="2" ry="2" /><line x1="1" y1="10" x2="23" y2="10" /></>,
            'briefcase': <><rect width="20" height="14" x="2" y="7" rx="2" ry="2" /><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16" /></>,
            'users': <><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" /><circle cx="9" cy="7" r="4" /><path d="M22 21v-2a4 4 0 0 0-3-3.87" /><path d="M16 3.13a4 4 0 0 1 0 7.75" /></>,
            'plus': <><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></>,
            'list': <><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></>,
            'pie-chart': <><path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path><path d="M22 12A10 10 0 0 0 12 2v10z"></path></>,
            'lock': <><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></>,
            'file-text': <><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></>,
            'check': <polyline points="20 6 9 17 4 12"></polyline>,
            'edit-2': <><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></>,
            'calculator': <><rect x="4" y="2" width="16" height="20" rx="2"></rect><line x1="8" y1="6" x2="16" y2="6"></line><line x1="16" y1="14" x2="16" y2="14"></line><line x1="8" y1="14" x2="8" y2="14"></line><line x1="12" y1="14" x2="12" y2="14"></line><line x1="8" y1="18" x2="8" y2="18"></line><line x1="12" y1="18" x2="12" y2="18"></line><line x1="16" y1="18" x2="16" y2="18"></line></>,
            'x': <><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></>,
            'wifi-off': <><line x1="1" y1="1" x2="23" y2="23"></line><path d="M16.72 11.06A10.94 10.94 0 0 1 19 12.55"></path><path d="M5 12.55a10.94 10.94 0 0 1 5.17-2.39"></path><path d="M10.71 5.05A16 16 0 0 1 22.58 9"></path><path d="M1.42 9a15.91 15.91 0 0 1 4.7-2.88"></path><path d="M8.53 16.11a6 6 0 0 1 6.95 0"></path><line x1="12" y1="20" x2="12.01" y2="20"></line></>,
            'download-cloud': <><polyline points="8 17 12 21 16 17"></polyline><line x1="12" y1="12" x2="12" y2="21"></line><path d="M20.88 18.09A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.29"></path></>
        };

        const IconWrapper = ({ name, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} style={{ display: 'inline-block', verticalAlign: 'middle' }}>
                {icons[name] || null}
            </svg>
        );

        // --- COMPONENTE DO EST√öDIO (PROJETO 2 - V31.1 Clean Edition) ---
        const CardStudio = ({ onExit }) => {
            const [activeScreen, setActiveScreen] = useState('editor');
            const [themeMode, setThemeMode] = useState('light');
            const [streak, setStreak] = useState(0);
            const [emojiOpen, setEmojiOpen] = useState(false);
            const [isTypewriter, setIsTypewriter] = useState(true); // Estado para m√°quina de escrever
            
            const [cardData, setCardData] = useState({
                titulo: 'Bom Dia',
                versiculo: 'Tudo posso naquele que me fortalece.',
                referencia: 'Filipenses 4:13',
                mensagem: 'Que o seu dia seja iluminado e cheio de vit√≥rias!',
                autor: 'Sistema Vida',
                fontSize: 16,
                blur: 0,
                opacity: 90,
                themeClass: 't-clean',
                frameClass: '',
                fontClass: 'font-modern',
                formatClass: 'fmt-feed',
                bgImage: null,
                sticker: '',
                isBw: false,
                align: 'align-center',
                dim: false
            });

            const dbMsg = [
                { tags: "financeiro dinheiro sucesso", titulo: "Deus Prover√°", ref: "Filipenses 4:19", msg: "Sua conta banc√°ria n√£o limita o poder de Deus. A provis√£o est√° a caminho." },
                { tags: "sucesso trabalho foco", titulo: "N√£o Desista", ref: "G√°latas 6:9", msg: "O sucesso √© a soma de pequenos esfor√ßos repetidos dia ap√≥s dia. Continue plantando." },
                { tags: "ansiedade medo paz", titulo: "Paz Real", ref: "Jo√£o 14:27", msg: "Respire fundo. O controle do universo est√° nas m√£os de quem te ama." },
                { tags: "fam√≠lia casa amor", titulo: "Lar Protegido", ref: "Josu√© 24:15", msg: "Deus est√° levantando muros de prote√ß√£o ao redor da sua fam√≠lia hoje." },
                { tags: "sa√∫de cura gym treino", titulo: "For√ßa Renovada", ref: "Isa√≠as 40:29", msg: "Seu corpo √© templo. Cuide dele com respeito e disciplina. Voc√™ √© mais forte do que imagina." },
                { tags: "gratid√£o f√©", titulo: "Novo F√¥lego", ref: "Lamenta√ß√µes 3:22", msg: "Voc√™ acordou! Isso √© a prova de que Deus ainda n√£o terminou com voc√™." }
            ];

            const emojis = ["üôè", "üôå", "‚ú®", "‚ù§Ô∏è", "‚úùÔ∏è", "üïäÔ∏è", "üìñ", "üî•", "üí°", "üòä", "üí™", "üõ°Ô∏è", "üëë", "üåø", "üåü", "üíñ", "ü§ù", "üò≠", "üåª", "üòá", "ü¶Å", "üåà", "‚òÄÔ∏è", "üöÄ", "üí∞", "üíº", "üß†"];
            const magicBackgrounds = ["https://images.unsplash.com/photo-1519681393798-3828fb4090bb?q=80&w=1000", "https://images.unsplash.com/photo-1470071459604-3b5ec3a7fe05?q=80&w=1000", "https://images.unsplash.com/photo-1506744038136-46273834b3fb?q=80&w=1000"];
            
            const themes = ['t-clean', 't-dark', 't-ocean', 't-nature', 't-gold', 't-sunset', 't-royal', 't-berry', 't-mint'];
            const fonts = ['font-modern', 'font-classic', 'font-hand', 'font-bold', 'font-marker'];

            // Init Streak & Particles
            useEffect(() => {
                const container = document.getElementById('studio-particles');
                if(container && container.innerHTML === '') {
                    for(let i=0; i<15; i++) {
                        const p = document.createElement('div');
                        p.className = 'particle';
                        const size = Math.random() * 5 + 2;
                        p.style.width = size + 'px'; p.style.height = size + 'px';
                        p.style.left = Math.random() * 100 + '%';
                        p.style.animationDuration = (Math.random() * 10 + 10) + 's';
                        p.style.animationDelay = (Math.random() * 5) + 's';
                        container.appendChild(p);
                    }
                }
                let last = localStorage.getItem('lastVisit');
                let s = parseInt(localStorage.getItem('streak') || 0);
                const today = new Date().toDateString();
                if (last !== today) { 
                    const yesterday = new Date(Date.now() - 86400000).toDateString();
                    if (last === yesterday) s++; else s = 1;
                    localStorage.setItem('lastVisit', today); localStorage.setItem('streak', s); 
                }
                setStreak(s);
            }, []);

            // Drag Logic
            useEffect(() => {
                if(activeScreen === 'preview') {
                    const container = document.getElementById('card-container-3d');
                    const card = document.getElementById('card-capture');
                    if(container && card) {
                        const handleMove = (e) => {
                            const rect = container.getBoundingClientRect();
                            const x = e.clientX - rect.left; const y = e.clientY - rect.top;
                            const centerX = rect.width / 2; const centerY = rect.height / 2;
                            const rotateX = ((y - centerY) / centerY) * -10; 
                            const rotateY = ((x - centerX) / centerX) * 10;
                            card.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg)`;
                        };
                        const handleLeave = () => card.style.transform = 'perspective(1000px) rotateX(0) rotateY(0)';
                        container.addEventListener('mousemove', handleMove);
                        container.addEventListener('mouseleave', handleLeave);
                        return () => { container.removeEventListener('mousemove', handleMove); container.removeEventListener('mouseleave', handleLeave); }
                    }
                    
                    const draggables = document.querySelectorAll('.draggable-item');
                    draggables.forEach(el => {
                        let isDragging = false;
                        let startX, startY, initialX, initialY;

                        const start = (e) => {
                            isDragging = true;
                            startX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX;
                            startY = e.type === 'touchstart' ? e.touches[0].clientY : e.clientY;
                            const style = window.getComputedStyle(el);
                            const matrix = new WebKitCSSMatrix(style.transform);
                            initialX = matrix.m41; initialY = matrix.m42;
                        };
                        const move = (e) => {
                            if(!isDragging) return;
                            e.preventDefault();
                            const cx = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX;
                            const cy = e.type === 'touchmove' ? e.touches[0].clientY : e.clientY;
                            el.style.transform = `translate(${initialX + (cx - startX)}px, ${initialY + (cy - startY)}px)`;
                        };
                        const end = () => isDragging = false;

                        el.addEventListener('mousedown', start); el.addEventListener('touchstart', start, {passive:false});
                        window.addEventListener('mousemove', move); window.addEventListener('touchmove', move, {passive:false});
                        window.addEventListener('mouseup', end); window.addEventListener('touchend', end);
                    });
                }
            }, [activeScreen]);

            // Helper Functions
            const gerarConteudo = (tag) => {
                const search = tag ? tag.toLowerCase() : document.querySelector('.search-input').value.toLowerCase();
                const pool = search ? dbMsg.filter(i => i.tags.includes(search)) : dbMsg;
                const item = pool.length ? pool[Math.floor(Math.random() * pool.length)] : dbMsg[0];
                setCardData(prev => ({ ...prev, titulo: item.titulo, referencia: item.ref, mensagem: item.msg }));
                setActiveScreen('preview');
            };
            
            const gerarAleatorio = () => {
                const item = dbMsg[Math.floor(Math.random() * dbMsg.length)];
                const randomTheme = themes[Math.floor(Math.random() * themes.length)];
                const randomFont = fonts[Math.floor(Math.random() * fonts.length)];
                
                setCardData(prev => ({
                    ...prev,
                    titulo: item.titulo,
                    referencia: item.ref,
                    mensagem: item.msg,
                    themeClass: randomTheme,
                    fontClass: randomFont,
                    bgImage: null
                }));
                setActiveScreen('preview');
                alert("‚ú® Nova inspira√ß√£o gerada!");
            };

            const downloadImage = () => {
                const card = document.getElementById('card-capture');
                const originalTransform = card.style.transform;
                card.style.transform = 'none';
                html2canvas(card, { scale: 3, backgroundColor: null, useCORS: true, allowTaint: true }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = 'sistema_vida_card.png';
                    link.href = canvas.toDataURL();
                    link.click();
                    card.style.transform = originalTransform; 
                });
            };

            const lerMensagem = () => {
                const text = `${cardData.titulo}. ${cardData.mensagem}`;
                const synth = window.speechSynthesis;
                if(synth.speaking) { synth.cancel(); return; }
                const utter = new SpeechSynthesisUtterance(text);
                utter.lang = 'pt-BR';
                synth.speak(utter);
            };

            const compartilhar = async () => {
                const card = document.getElementById('card-capture');
                const originalTransform = card.style.transform;
                card.style.transform = 'none';
                try {
                    const canvas = await html2canvas(card, { scale: 2, useCORS: true, allowTaint: true, backgroundColor: null });
                    canvas.toBlob(async (blob) => {
                        if (navigator.share) {
                            const file = new File([blob], "sistema_vida.png", { type: "image/png" });
                            navigator.share({ files: [file], title: 'Sistema Vida', text: 'Minha mensagem do dia!' });
                        } else {
                            const item = new ClipboardItem({ "image/png": blob });
                            await navigator.clipboard.write([item]);
                            alert("Imagem copiada! Cole no WhatsApp.");
                        }
                    });
                } catch(e) { alert("Erro ao compartilhar."); }
                card.style.transform = originalTransform;
            };

            const handleBgUpload = (e) => {
                if (e.target.files && e.target.files[0]) {
                    const reader = new FileReader();
                    reader.onload = (evt) => setCardData(prev => ({...prev, bgImage: evt.target.result, themeClass: 't-dark'}));
                    reader.readAsDataURL(e.target.files[0]);
                }
            };

            const magicBg = () => {
                const randomImg = magicBackgrounds[Math.floor(Math.random() * magicBackgrounds.length)];
                setCardData(prev => ({...prev, bgImage: randomImg, themeClass: 't-dark', dim: true}));
            };

            const insertEmoji = (emoji) => {
                setCardData(prev => ({...prev, mensagem: prev.mensagem + emoji}));
            };

            const resetPositions = () => {
                 document.querySelectorAll('.draggable-item').forEach(el => {
                    el.style.transform = 'translate(0, 0)';
                });
                alert("Posi√ß√µes Restauradas üîÑ");
            };

            return (
                <div className="studio-wrapper" data-theme={themeMode}>
                    <div id="studio-particles" className="studio-particles"></div>
                    <div className="studio-header">
                        <div className="flex flex-col"><span className="font-bold text-red-600 text-lg">Sistema Vida</span><span className="text-[10px] uppercase tracking-widest opacity-60">Clean 31.1</span></div>
                        <div className="streak-badge"><i className="fas fa-fire"></i> {streak} Dia</div>
                        <button onClick={onExit} className="text-xs bg-gray-200 px-3 py-1 rounded-full font-bold hover:bg-gray-300 ml-2">Sair</button>
                    </div>
                    <div className="studio-container">
                        {activeScreen === 'editor' && (
                            <div className="animate-fadeIn">
                                <div className="tools-section">
                                    <h3 className="text-xs font-bold text-gray-400 uppercase mb-3"><i className="fas fa-bolt text-yellow-500 mr-2"></i> Gerador R√°pido</h3>
                                    <div className="search-row"><i className="fas fa-search search-icon"></i><input type="text" className="search-input" placeholder="Sobre o que quer falar?" /><button className="btn-magic" onClick={() => gerarConteudo()}><i className="fas fa-wand-magic-sparkles"></i></button></div>
                                    <div className="cat-scroll">{['Sucesso', 'F√©', 'Ansiedade', 'Amor', 'Gratid√£o', 'Gym'].map(tag => (<div key={tag} className="cat-chip" onClick={() => gerarConteudo(tag)}>{tag}</div>))}</div>
                                </div>
                                <div className="emoji-bar">
                                    <button onClick={()=>setEmojiOpen(!emojiOpen)} className="w-full bg-gray-100 p-3 rounded-xl text-xs font-bold text-gray-500 flex justify-center gap-2"><i className="far fa-smile"></i> Galeria de Emojis</button>
                                    <div className={`emoji-grid ${emojiOpen ? 'show' : ''}`}>{emojis.map(e => <div key={e} className="emoji-item" onClick={()=>insertEmoji(e)}>{e}</div>)}</div>
                                </div>
                                <div className="space-y-4">
                                    <div><label className="text-xs font-bold text-gray-500 uppercase">T√≠tulo</label><input className="track-input" value={cardData.titulo} onChange={e => setCardData({...cardData, titulo: e.target.value})} /></div>
                                    <div><label className="text-xs font-bold text-gray-500 uppercase">Vers√≠culo</label><textarea className="track-input" rows="2" value={cardData.versiculo} onChange={e => setCardData({...cardData, versiculo: e.target.value})}></textarea><input className="track-input mt-2" placeholder="Refer√™ncia" value={cardData.referencia} onChange={e => setCardData({...cardData, referencia: e.target.value})} /></div>
                                    <div><label className="text-xs font-bold text-gray-500 uppercase">Mensagem</label><textarea className="track-input" rows="4" value={cardData.mensagem} onChange={e => setCardData({...cardData, mensagem: e.target.value})}></textarea></div>
                                    <div><label className="text-xs font-bold text-gray-500 uppercase">Assinatura</label><input className="track-input" value={cardData.autor} onChange={e => setCardData({...cardData, autor: e.target.value})} /></div>
                                </div>
                                <div style={{height:'100px'}}></div>
                            </div>
                        )}
                        {activeScreen === 'preview' && (
                            <div className="animate-fadeIn pb-24">
                                <div className="top-nav-bar"><button className="btn-back" onClick={() => setActiveScreen('editor')}><i className="fas fa-arrow-left"></i> Voltar</button><button className="btn-inspire" onClick={gerarAleatorio}><i className="fas fa-random"></i> Surpreenda-me</button></div>
                                <div className="slider-box"><div className="slider-row"><div className="slider-wrapper"><span className="slider-label">Tamanho</span><input type="range" min="12" max="32" value={cardData.fontSize} onChange={e => setCardData({...cardData, fontSize: e.target.value})} /></div><div className="slider-wrapper"><span className="slider-label">Opacidade</span><input type="range" min="0" max="100" value={cardData.opacity} onChange={e => setCardData({...cardData, opacity: e.target.value})} /></div></div><div className="slider-wrapper"><span className="slider-label">Blur Fundo</span><input type="range" min="0" max="10" value={cardData.blur} onChange={e => setCardData({...cardData, blur: e.target.value})} /></div></div>
                                <div className="preview-container-3d" id="card-container-3d">
                                    <div id="card-capture" className={`card-preview-wrapper ${cardData.themeClass} ${cardData.frameClass} ${cardData.fontClass} ${cardData.formatClass} ${cardData.isBw ? 'filter-bw' : ''} ${cardData.align}`} style={{ backgroundImage: cardData.bgImage ? `url(${cardData.bgImage})` : '', backgroundSize: 'cover', backgroundPosition: 'center' }}>
                                        <div className={`card-sticker draggable-item ${cardData.sticker ? 'visible' : ''}`}>{cardData.sticker}</div>
                                        <div className={`card-overlay ${cardData.dim || cardData.bgImage ? 'dimmer-heavy' : ''}`} style={{backdropFilter: `blur(${cardData.blur}px)`}}></div>
                                        <div className="card-content-layer" style={{fontSize: `${cardData.fontSize}px`}}>
                                            <div className="pv-title draggable-item">{cardData.titulo}</div>
                                            <div className="pv-ref draggable-item">{cardData.referencia}</div>
                                            <div className="pv-verse draggable-item">"{cardData.versiculo}"</div>
                                            <div className="pv-msg draggable-item" style={{backgroundColor: `rgba(255,255,255, ${cardData.opacity/100})`}}>{cardData.mensagem}{isTypewriter && <span className="cursor-blink">|</span>}</div>
                                            <div className="pv-footer draggable-item"><i className="fas fa-heart text-red-500"></i> {cardData.autor} ‚Ä¢ {new Date().toLocaleDateString('pt-BR')}</div>
                                        </div>
                                        <div className="music-overlay"><div className="music-bar"><div className="music-progress"></div></div><div className="music-time"><span>1:34</span><span>3:45</span></div><div className="music-controls"><i className="fas fa-backward-step"></i><i className="fas fa-circle-play" style={{fontSize:'2.5rem'}}></i><i className="fas fa-forward-step"></i></div></div>
                                    </div>
                                </div>
                                <div className="format-bar">
                                    <div className={`fmt-btn ${cardData.formatClass==='fmt-feed'?'active':''}`} onClick={()=>setCardData({...cardData, formatClass:'fmt-feed'})}><i className="far fa-square"></i> Feed</div>
                                    <div className={`fmt-btn ${cardData.formatClass==='fmt-music'?'active':''}`} onClick={()=>{setCardData({...cardData, formatClass:'fmt-music'}); magicBg(); alert("Modo M√∫sica Ativado üéµ");}}><i className="fab fa-spotify"></i> Music</div>
                                    <div className={`fmt-btn ${cardData.formatClass==='fmt-story'?'active':''}`} onClick={()=>setCardData({...cardData, formatClass:'fmt-story'})}><i className="fas fa-mobile-alt"></i> Stories</div>
                                </div>
                                <div className="preview-controls"><button className={`tool-btn ${cardData.frameClass === '' ? 'active' : ''}`} onClick={()=>setCardData({...cardData, frameClass: ''})}>üö´</button><button className="tool-btn" onClick={()=>setCardData({...cardData, frameClass: 'frame-white'})}>‚¨ú</button><button className="tool-btn" onClick={()=>setCardData({...cardData, frameClass: 'frame-black'})}>‚¨õ</button><button className="tool-btn" onClick={()=>setCardData({...cardData, frameClass: 'frame-gold'})}>üëë</button><button className="tool-btn" onClick={()=>setCardData({...cardData, frameClass: 'frame-neon-pink'})}>üîÆ</button><button className="tool-btn" onClick={()=>setCardData({...cardData, frameClass: 'frame-polaroid-clean'})}>üì∏</button></div>
                                <div className="scroll-tools">
                                    <div className="tool-row"><button className="tool-btn" onClick={()=>setCardData({...cardData, sticker: ''})}><i className="fas fa-ban"></i></button><button className="tool-btn" onClick={()=>setCardData({...cardData, sticker: 'Bom Dia ‚òÄÔ∏è'})}>Bom Dia</button><button className="tool-btn" onClick={()=>setCardData({...cardData, sticker: 'Boa Noite üåô'})}>Boa Noite</button><button className="tool-btn" onClick={()=>setCardData({...cardData, sticker: 'Gratid√£o üôè'})}>Gratid√£o</button><button className="tool-btn" onClick={()=>setCardData({...cardData, sticker: 'F√© ‚úùÔ∏è'})}>F√©</button><button className="tool-btn" onClick={()=>setCardData({...cardData, sticker: 'Vers√≠culo üìñ'})}>Vers√≠culo</button></div>
                                    <div className="tool-row"><button className="tool-btn" onClick={()=>setCardData({...cardData, fontClass: 'font-hand'})}><i className="fas fa-font"></i> Fonte</button><button className="tool-btn" onClick={resetPositions}><i className="fas fa-sync-alt"></i> Reset</button><button className="tool-btn" onClick={()=>setIsTypewriter(!isTypewriter)}><i className="fas fa-keyboard"></i> Digitar</button><button className="tool-btn" onClick={()=>setCardData({...cardData, align: cardData.align==='align-left'?'align-center':'align-left'})}><i className="fas fa-align-center"></i> Alinhar</button><button className="tool-btn" onClick={()=>setCardData({...cardData, dim: !cardData.dim})}><i className="fas fa-adjust"></i> Sombra</button><button className="tool-btn" onClick={()=>setCardData({...cardData, isBw: !cardData.isBw})}>P&B</button></div>
                                </div>
                                <div className="preview-controls"><label className="theme-btn upload-btn"><i className="fas fa-camera"></i><input type="file" className="hidden" accept="image/*" onChange={handleBgUpload}/></label><button className="theme-btn magic-btn" onClick={magicBg}><i className="fas fa-wand-magic-sparkles"></i></button><div className="theme-btn t-clean active" onClick={()=>setCardData({...cardData, themeClass: 't-clean', bgImage: null})}></div><div className="theme-btn t-dark" onClick={()=>setCardData({...cardData, themeClass: 't-dark', bgImage: null})}></div><div className="theme-btn t-ocean" onClick={()=>setCardData({...cardData, themeClass: 't-ocean', bgImage: null})}></div><div className="theme-btn t-nature" onClick={()=>setCardData({...cardData, themeClass: 't-nature', bgImage: null})}></div><div className="theme-btn t-gold" onClick={()=>setCardData({...cardData, themeClass: 't-gold', bgImage: null})}></div><div className="theme-btn t-sunset" onClick={()=>setCardData({...cardData, themeClass: 't-sunset', bgImage: null})}></div><div className="theme-btn t-royal" onClick={()=>setCardData({...cardData, themeClass: 't-royal', bgImage: null})}></div><div className="theme-btn t-berry" onClick={()=>setCardData({...cardData, themeClass: 't-berry', bgImage: null})}></div><div className="theme-btn t-mint" onClick={()=>setCardData({...cardData, themeClass: 't-mint', bgImage: null})}></div></div>
                                <div className="actions-grid"><button className="btn-action btn-audio" onClick={lerMensagem}><i className="fas fa-volume-up"></i> Ouvir</button><button className="btn-action btn-share" onClick={compartilhar}><i className="fab fa-whatsapp"></i> Enviar Zap</button><button className="btn-action btn-save" onClick={downloadImage}><i className="fas fa-download"></i> Salvar</button><button className="btn-action btn-copy" onClick={()=>{navigator.clipboard.writeText(cardData.mensagem); alert("Texto copiado!");}}><i className="fas fa-copy"></i> Copiar</button></div>
                            </div>
                        )}
                    </div>
                    <div className="studio-bottom-nav"><button className={`studio-nav-item ${activeScreen === 'editor' ? 'active' : ''}`} onClick={() => setActiveScreen('editor')}><i className="fas fa-pen"></i></button><button className={`studio-nav-item ${activeScreen === 'preview' ? 'active' : ''}`} onClick={() => setActiveScreen('preview')}><i className="fas fa-image"></i></button><button className="studio-nav-item" onClick={() => setThemeMode(themeMode === 'light' ? 'dark' : 'light')}><i className={`fas fa-${themeMode === 'light' ? 'moon' : 'sun'}`}></i></button></div>
                </div>
            );
        };

        // --- COMPONENTE CALCULADORA FLUTUANTE ---
        const DraggableCalculator = ({ onClose }) => {
            const [position, setPosition] = useState({ x: window.innerWidth/2 - 130, y: 100 });
            const [isDragging, setIsDragging] = useState(false);
            const [rel, setRel] = useState({ x: 0, y: 0 });
            const [display, setDisplay] = useState('0');
            const [expression, setExpression] = useState('');

            const handleMouseDown = (e) => {
                if(e.target.closest('button')) return;
                setIsDragging(true);
                setRel({
                    x: (e.pageX || e.touches[0].pageX) - position.x,
                    y: (e.pageY || e.touches[0].pageY) - position.y
                });
            };

            useEffect(() => {
                const handleMouseMove = (e) => {
                    if (!isDragging) return;
                    e.preventDefault();
                    const pageX = e.pageX || (e.touches ? e.touches[0].pageX : 0);
                    const pageY = e.pageY || (e.touches ? e.touches[0].pageY : 0);
                    setPosition({ x: pageX - rel.x, y: pageY - rel.y });
                };
                const handleMouseUp = () => setIsDragging(false);

                if (isDragging) {
                    window.addEventListener('mousemove', handleMouseMove);
                    window.addEventListener('mouseup', handleMouseUp);
                    window.addEventListener('touchmove', handleMouseMove, { passive: false });
                    window.addEventListener('touchend', handleMouseUp);
                }
                return () => {
                    window.removeEventListener('mousemove', handleMouseMove);
                    window.removeEventListener('mouseup', handleMouseUp);
                    window.removeEventListener('touchmove', handleMouseMove);
                    window.removeEventListener('touchend', handleMouseUp);
                };
            }, [isDragging, rel]);

            const handleBtnClick = (val) => {
                if (val === 'C') { setDisplay('0'); setExpression(''); } 
                else if (val === '=') {
                    try {
                        const result = eval(expression.replace(/x/g, '*').replace(/%/g, '/100'));
                        setDisplay(String(result)); setExpression(String(result));
                    } catch { setDisplay('Erro'); setExpression(''); }
                } else {
                    const nextExpr = (display === '0' || display === 'Erro' ? '' : expression) + val;
                    setExpression(nextExpr); setDisplay(nextExpr);
                }
            };

            const buttons = ['C', '(', ')', '/', '7', '8', '9', 'x', '4', '5', '6', '-', '1', '2', '3', '+', '0', '.', '%', '='];

            return (
                <div className="fixed z-[100] bg-gray-900 rounded-xl shadow-2xl overflow-hidden border border-gray-700" style={{ left: position.x, top: position.y, width: '260px', touchAction: 'none' }}>
                    <div onMouseDown={handleMouseDown} onTouchStart={handleMouseDown} className="bg-gray-800 p-2 cursor-move flex justify-between items-center select-none">
                        <span className="text-gray-400 text-xs font-bold flex items-center gap-2"><IconWrapper name="calculator" size={14}/> Calculadora</span>
                        <button onClick={onClose} className="text-red-400 hover:text-red-200"><IconWrapper name="x" size={16}/></button>
                    </div>
                    <div className="p-4 bg-gray-900 text-right"><div className="text-3xl text-white font-mono truncate">{display}</div></div>
                    <div className="grid grid-cols-4 gap-1 p-2 bg-gray-800">
                        {buttons.map((btn, i) => (
                            <button key={i} onClick={() => handleBtnClick(btn)} className={`p-3 rounded font-bold text-lg transition-colors ${btn === '=' ? 'bg-orange-500 text-white' : btn === 'C' ? 'bg-red-900 text-red-100' : ['/','x','-','+'].includes(btn) ? 'bg-gray-700 text-orange-400' : 'bg-gray-700 text-white'}`}>{btn}</button>
                        ))}
                    </div>
                </div>
            );
        };

        // --- GR√ÅFICO DE PIZZA ---
        const SimplePieChart = ({ data, onSliceClick }) => {
            const validData = data.filter(d => d.value > 0);
            const total = validData.reduce((acc, item) => acc + item.value, 0);
            if (total === 0) return <div className="text-center text-gray-400 p-4 text-sm">Sem dados para o gr√°fico</div>;
            
            let cumulativeAngle = 0;
            return (
                <div className="flex flex-col items-center bg-white p-6 rounded-xl shadow-lg border border-gray-100 mt-8 mb-8 no-print">
                    <h3 className="font-bold text-gray-700 mb-4 flex items-center gap-2"><IconWrapper name="pie-chart" className="text-purple-500"/> Distribui√ß√£o Financeira</h3>
                    <div className="relative w-48 h-48">
                        <svg viewBox="-1 -1 2 2" style={{ transform: 'rotate(-90deg)', width: '100%', height: '100%' }}>
                            {validData.map((slice, index) => {
                                const startAngle = cumulativeAngle;
                                const sliceAngle = (slice.value / total) * 2 * Math.PI;
                                cumulativeAngle += sliceAngle;
                                const x1 = Math.cos(startAngle); const y1 = Math.sin(startAngle);
                                const x2 = Math.cos(startAngle + sliceAngle); const y2 = Math.sin(startAngle + sliceAngle);
                                const largeArcFlag = sliceAngle > Math.PI ? 1 : 0;
                                const pathData = (validData.length === 1) ? `M 0 0 L ${x1} ${y1} A 1 1 0 1 1 ${x1} ${y1 - 0.0001} Z` : `M 0 0 L ${x1} ${y1} A 1 1 0 ${largeArcFlag} 1 ${x2} ${y2} Z`;
                                return <path key={index} d={pathData} fill={slice.color} stroke="white" strokeWidth="0.05" onClick={() => onSliceClick && onSliceClick(slice.label)} />;
                            })}
                        </svg>
                    </div>
                    <div className="mt-6 w-full grid grid-cols-1 gap-3">
                        {data.map((item, i) => (
                            <div key={i} className="flex items-center justify-between p-2 rounded bg-gray-50 cursor-pointer hover:bg-gray-100" onClick={() => onSliceClick && onSliceClick(item.label)}>
                                <div className="flex items-center gap-2"><div className="w-3 h-3 rounded-full" style={{backgroundColor: item.color}}></div><span className="text-gray-600 text-xs font-bold uppercase">{item.label}</span></div>
                                <span className="font-bold text-gray-800 text-sm">R$ {item.value.toFixed(2)}</span>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // --- ABA FINANCEIRA INTEGRADA ---
        const FinancialTab = () => {
            const [view, setView] = useState('transactions'); 
            const [showCalc, setShowCalc] = useState(false);
            
            const [financialEntries, setFinancialEntries] = usePersistentState('financialEntries_v4', []);
            const [userAssets, setUserAssets] = usePersistentState('userAssets_v3', []);
            const [userLoans, setUserLoans] = usePersistentState('userLoans_v3', []);
            const [userCards, setUserCards] = usePersistentState('userCards_v3', []);
            const [userInvestments, setUserInvestments] = usePersistentState('userInvestments_v1', []);
            const [userDebts, setUserDebts] = usePersistentState('userDebts_v3', []); 
            const [expandedCardId, setExpandedCardId] = useState(null);
            const [historyFilter, setHistoryFilter] = useState('all'); 
            
            const [editingId, setEditingId] = useState(null); 
            const [appPassword, setAppPassword] = usePersistentState('appPassword', ''); 
            const [isLocked, setIsLocked] = useState(false); 
            const [pinInput, setPinInput] = useState(''); 
            const [newPasswordInput, setNewPasswordInput] = useState(''); 

            const [finForm, setFinForm] = useState({ date: new Date().toISOString().split('T')[0], desc: '', value: '', type: 'expense', category: 'Outros', method: 'Dinheiro', installments: 1, cardId: '' });
            const [assetForm, setAssetForm] = useState({ name: '', value: '' });
            const [loanForm, setLoanForm] = useState({ name: '', desc: '', value: '', date: '' });
            const [cardForm, setCardForm] = useState({ name: '', limit: '', dueDay: '' });
            const [investmentForm, setInvestmentForm] = useState({ type: 'Poupan√ßa', name: '', value: '' });
            const [debtForm, setDebtForm] = useState({ name: '', totalValue: '', installments: '', startDate: '', dueDay: '' });

            useEffect(() => {
                const savedPass = localStorage.getItem('appPassword');
                if (savedPass && savedPass !== '""') setIsLocked(true);
            }, []);

            const summary = useMemo(() => {
                const realizedEntries = financialEntries.filter(e => e.status === 'paid');
                const income = realizedEntries.filter(e => e.type === 'income').reduce((acc, curr) => acc + curr.value, 0);
                const expense = realizedEntries.filter(e => e.type === 'expense').reduce((acc, curr) => acc + curr.value, 0);
                const pendingExpense = financialEntries.filter(e => e.status === 'pending' && e.type === 'expense').reduce((acc, curr) => acc + curr.value, 0);
                return { income, expense, balance: income - expense, pendingExpense };
            }, [financialEntries]);

            const chartData = useMemo(() => {
                const totalReceivable = userLoans.reduce((acc, curr) => acc + curr.value, 0);
                const totalCardDebt = financialEntries.filter(e => e.method === 'Cart√£o Cr√©dito' && e.type === 'expense' && e.status === 'pending').reduce((acc, curr) => acc + curr.value, 0);
                return [
                    { label: 'Saldo em Caixa', value: Math.max(0, summary.balance), color: '#10B981' }, 
                    { label: 'A Receber', value: totalReceivable, color: '#F59E0B' }, 
                    { label: 'Gasto c/ Cart√£o', value: totalCardDebt, color: '#EF4444' } 
                ];
            }, [userLoans, financialEntries, summary.balance]);

            const handleUnlock = () => { if (pinInput === appPassword) { setIsLocked(false); setPinInput(''); } else { alert("Senha incorreta!"); setPinInput(''); } };
            const handleSetPassword = () => { if (newPasswordInput.length < 4) return alert("M√≠nimo 4 d√≠gitos."); setAppPassword(newPasswordInput); setNewPasswordInput(''); alert("Senha definida!"); };
            const handleRemovePassword = () => { if (confirm("Remover prote√ß√£o?")) { setAppPassword(''); alert("Senha removida."); } };
            
            const handlePieClick = (label) => {
                if (label === 'Saldo em Caixa') setView('transactions');
                else if (label === 'A Receber') setView('loans');
                else if (label === 'Gasto c/ Cart√£o') setView('cards');
            };

            const getTotalCardUsage = (cardId) => financialEntries.filter(e => e.method === 'Cart√£o Cr√©dito' && e.cardId === cardId && e.type === 'expense' && e.status === 'pending').reduce((acc, curr) => acc + curr.value, 0);
            const getCurrentInvoiceValue = (cardId) => {
                const now = new Date();
                return financialEntries.filter(e => {
                        if (e.method !== 'Cart√£o Cr√©dito' || e.cardId !== cardId || e.type !== 'expense') return false;
                        const [y, m, d] = e.date.split('-').map(Number);
                        return (m - 1) === now.getMonth() && y === now.getFullYear();
                    }).reduce((acc, curr) => acc + curr.value, 0);
            };

            const handleAddEntry = () => {
                if (!finForm.desc || !finForm.value) return alert("Preencha descri√ß√£o e valor.");
                if (finForm.method === 'Cart√£o Cr√©dito' && !finForm.cardId && userCards.length > 0) return alert("Selecione o cart√£o.");
                const totalValue = parseFloat(finForm.value);

                if (editingId) {
                    if (!window.confirm("Confirma a altera√ß√£o deste lan√ßamento?")) return;
                    setFinancialEntries(financialEntries.map(entry => {
                        if (entry.id === editingId) {
                            return { ...entry, date: finForm.date, desc: finForm.desc, value: totalValue, type: finForm.type, category: finForm.category, method: finForm.method, cardId: finForm.method === 'Cart√£o Cr√©dito' ? finForm.cardId : null };
                        }
                        return entry;
                    }));
                    setEditingId(null); setFinForm({ ...finForm, desc: '', value: '', installments: 1 }); alert("Registo atualizado!"); return;
                }

                const numInstallments = parseInt(finForm.installments) || 1;
                const installmentValue = totalValue / numInstallments;
                const newEntries = [];
                let startDate; 
                
                if (finForm.method === 'Cart√£o Cr√©dito' && finForm.cardId) {
                    const selectedCard = userCards.find(c => c.id === finForm.cardId);
                    if (selectedCard && selectedCard.dueDay) {
                        const dueDay = parseInt(selectedCard.dueDay);
                        const [y, m, d] = finForm.date.split('-').map(Number);
                        const purchaseDate = new Date(y, m - 1, d);
                        let nextMonth = purchaseDate.getMonth() + 1;
                        let year = purchaseDate.getFullYear();
                        if (nextMonth > 11) { nextMonth = 0; year++; }
                        startDate = new Date(year, nextMonth, dueDay);
                    } else { const [y, m, d] = finForm.date.split('-').map(Number); startDate = new Date(y, m - 1, d); startDate.setMonth(startDate.getMonth() + 1); }
                } else { const [y, m, d] = finForm.date.split('-').map(Number); startDate = new Date(y, m - 1, d); }

                for (let i = 0; i < numInstallments; i++) {
                    const entryDate = new Date(startDate);
                    if (['Cart√£o Cr√©dito', 'Carn√™/Boleto'].includes(finForm.method) || i > 0) entryDate.setMonth(startDate.getMonth() + i);
                    
                    const y = entryDate.getFullYear(); const m = String(entryDate.getMonth() + 1).padStart(2, '0'); const d = String(entryDate.getDate()).padStart(2, '0');
                    let initialStatus = 'pending';
                    const today = new Date(); today.setHours(0,0,0,0); const checkDate = new Date(entryDate); checkDate.setHours(0,0,0,0);
                    if (['Dinheiro', 'Cart√£o D√©bito', 'Pix'].includes(finForm.method) && checkDate <= today) initialStatus = 'paid';

                    newEntries.push({ id: Date.now() + i, date: `${y}-${m}-${d}`, desc: numInstallments > 1 ? `${finForm.desc} (${i + 1}/${numInstallments})` : finForm.desc, value: installmentValue, type: finForm.type, category: finForm.category, method: finForm.method, cardId: finForm.method === 'Cart√£o Cr√©dito' ? finForm.cardId : null, status: initialStatus });
                }
                setFinancialEntries([...newEntries, ...financialEntries]); setFinForm({ ...finForm, desc: '', value: '', installments: 1 }); alert("Lan√ßamento(s) adicionado(s) ao Fluxo!");
            };

            const handleEditEntry = (entry) => { setEditingId(entry.id); setFinForm({ date: entry.date, desc: entry.desc, value: entry.value, type: entry.type, category: entry.category, method: entry.method, installments: 1, cardId: entry.cardId || '' }); window.scrollTo({ top: 0, behavior: 'smooth' }); };
            const cancelEdit = () => { setEditingId(null); setFinForm({ ...finForm, desc: '', value: '', installments: 1 }); };
            const handleAddAsset = () => { if (!assetForm.name || !assetForm.value) return alert("Preencha campos."); setUserAssets([...userAssets, { id: Date.now(), ...assetForm, value: parseFloat(assetForm.value) }]); setAssetForm({ name: '', value: '' }); };
            const handleAddLoan = () => {
                if (!loanForm.name || !loanForm.value || !loanForm.date) return alert("Preencha todos os campos.");
                const newLoanId = Date.now().toString(); const loanValue = parseFloat(loanForm.value);
                const newLoan = { id: newLoanId, ...loanForm, value: loanValue };
                const newEntry = { id: Date.now() + 1, date: loanForm.date, desc: `Recebimento: ${loanForm.name} - ${loanForm.desc}`, value: loanValue, type: 'income', category: 'Empr√©stimos', method: 'Dinheiro', status: 'pending', loanId: newLoanId };
                setUserLoans([...userLoans, newLoan]); setFinancialEntries([newEntry, ...financialEntries]); setLoanForm({ name: '', desc: '', value: '', date: '' }); alert("Registrado!");
            };
            const handleAddCard = () => { if (!cardForm.name || !cardForm.limit || !cardForm.dueDay) return alert("Preencha campos."); setUserCards([...userCards, { id: Date.now().toString(), ...cardForm, limit: parseFloat(cardForm.limit), dueDay: cardForm.dueDay }]); setCardForm({ name: '', limit: '', dueDay: '' }); };
            const handleAddInvestment = () => { if (!investmentForm.name || !investmentForm.value) return alert("Preencha campos."); setUserInvestments([...userInvestments, { id: Date.now(), ...investmentForm, value: parseFloat(investmentForm.value) }]); setInvestmentForm({ type: 'Poupan√ßa', name: '', value: '' }); };
            const handleAddDebt = () => {
                if (!debtForm.name || !debtForm.totalValue || !debtForm.installments || !debtForm.dueDay) return alert("Preencha todos os campos.");
                const newDebtId = Date.now().toString(); const installments = parseInt(debtForm.installments); const totalValue = parseFloat(debtForm.totalValue); const installmentValue = totalValue / installments; const dueDay = parseInt(debtForm.dueDay);
                const today = new Date(); let startMonth = today.getMonth(); let startYear = today.getFullYear();
                if (today.getDate() >= dueDay) { startMonth++; if(startMonth > 11) { startMonth = 0; startYear++; } }
                const debtStartDate = new Date(startYear, startMonth, dueDay); const newEntries = [];
                for (let i = 0; i < installments; i++) {
                    const entryDate = new Date(debtStartDate); entryDate.setMonth(debtStartDate.getMonth() + i);
                    const y = entryDate.getFullYear(); const m = String(entryDate.getMonth() + 1).padStart(2, '0'); const d = String(entryDate.getDate()).padStart(2, '0');
                    newEntries.push({ id: Date.now() + i, date: `${y}-${m}-${d}`, desc: `${debtForm.name} (${i + 1}/${installments})`, value: installmentValue, type: 'expense', category: 'D√≠vida/Financ.', method: 'Carn√™/Boleto', status: 'pending', debtId: newDebtId });
                }
                setUserDebts([...userDebts, { id: newDebtId, ...debtForm, totalValue: totalValue, installments: installments }]);
                setFinancialEntries([...newEntries, ...financialEntries]); setDebtForm({ name: '', totalValue: '', installments: '', startDate: '', dueDay: '' }); alert("D√≠vida cadastrada!");
            };

            const deleteItem = (id, list, setList) => { if(confirm("Excluir item?")) setList(list.filter(i => i.id !== id)); };
            const handleTrashClick = (entry) => {
                if (entry.status === 'paid') { if (confirm("Ocultar item do hist√≥rico? O valor continuar√° no Saldo.")) setFinancialEntries(financialEntries.map(e => e.id === entry.id ? { ...e, hidden: true } : e)); } 
                else { if (confirm("Excluir lan√ßamento pendente permanentemente?")) setFinancialEntries(financialEntries.filter(e => e.id !== entry.id)); }
            };
            const deleteHiddenItem = (id) => { if(confirm("Tem certeza? Isso apagar√° este item definitivamente e ALTERAR√Å o seu Saldo.")) setFinancialEntries(financialEntries.filter(e => e.id !== id)); };
            const clearHiddenItems = () => { if(confirm(`Tem certeza? Isso apagar√° todos itens ocultos e ALTERAR√Å o seu Saldo.`)) setFinancialEntries(financialEntries.filter(e => !e.hidden)); };
            const deleteDebt = (id) => { if(confirm("Apagar d√≠vida e todas as parcelas pendentes?")) { setUserDebts(userDebts.filter(d => d.id !== id)); setFinancialEntries(financialEntries.filter(e => !(e.debtId === id && e.status === 'pending'))); } };
            const deleteLoan = (id) => { if(confirm("Apagar registro em 'Receber' e remover a entrada pendente do Fluxo?")) { setUserLoans(userLoans.filter(l => l.id !== id)); setFinancialEntries(financialEntries.filter(e => !(e.loanId === id && e.status === 'pending'))); } };
            const toggleEntryStatus = (id) => { setFinancialEntries(financialEntries.map(entry => { if (entry.id === id) return { ...entry, status: entry.status === 'paid' ? 'pending' : 'paid' }; return entry; })); };
            const getCardName = (cardId) => { const card = userCards.find(c => c.id === cardId); return card ? card.name : 'Cart√£o Exclu√≠do'; };
            const toggleCardDetails = (cardId) => { setExpandedCardId(expandedCardId === cardId ? null : cardId); };
            const isOverdue = (dateStr) => { if (!dateStr) return false; const [y, m, d] = dateStr.split('-').map(Number); const date = new Date(y, m-1, d); const today = new Date(); today.setHours(0,0,0,0); return date < today; };
            const getDebtProgress = (debtId) => { const debtEntries = financialEntries.filter(e => e.debtId === debtId); const paidCount = debtEntries.filter(e => e.status === 'paid').length; return { paid: paidCount, total: debtEntries.length > 0 ? debtEntries.length : 1 }; };

            const filteredEntries = useMemo(() => {
                return financialEntries.filter(entry => { if (entry.hidden) return false; if (historyFilter === 'all') return true; if (historyFilter === 'paid') return entry.status === 'paid'; if (historyFilter === 'pending') return entry.status === 'pending'; return true; });
            }, [financialEntries, historyFilter]);

            if (isLocked) {
                return ( <div className="min-h-[50vh] flex flex-col items-center justify-center p-4 animate-fadeIn"> <div className="bg-gray-800 p-8 rounded-2xl shadow-2xl w-full max-w-sm text-center"> <div className="mb-6 text-yellow-400"><IconWrapper name="lock" size={64} /></div> <h2 className="text-2xl font-bold mb-2 text-white">Agenda Bloqueada</h2> <p className="text-gray-400 mb-6 text-sm">Prote√ß√£o Ativa.</p> <input type="password" value={pinInput} onChange={(e) => setPinInput(e.target.value)} className="w-full p-4 text-center text-2xl bg-gray-700 rounded-lg border border-gray-600 text-white mb-4 tracking-widest outline-none focus:border-yellow-500 transition-colors" placeholder="****" maxLength="6" inputMode="numeric" /> <button onClick={handleUnlock} className="w-full bg-yellow-500 text-gray-900 font-bold py-3 rounded-lg hover:bg-yellow-400 transition-transform active:scale-95">Desbloquear</button> </div> </div> );
            }

            return (
                <div className="bg-gray-100 min-h-screen pb-20">
                    {showCalc && <DraggableCalculator onClose={() => setShowCalc(false)} />}
                    <div className="bg-white shadow px-4 pt-4 pb-2 sticky top-0 z-40">
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="font-bold text-lg text-gray-800 flex items-center gap-2"><IconWrapper name="dollar-sign" className="text-green-600"/> Financeiro</h2>
                            <div className="flex gap-2">
                                <button onClick={() => setView('settings')} className="p-2 bg-gray-200 rounded hover:bg-gray-300 text-gray-600"><IconWrapper name="lock" size={18} /></button>
                                <button onClick={() => setView('statement')} className="p-2 bg-gray-200 rounded hover:bg-gray-300 text-gray-600"><IconWrapper name="file-text" size={18}/></button>
                                <button onClick={() => setShowCalc(!showCalc)} className={`p-2 rounded hover:bg-gray-300 text-gray-600 ${showCalc ? 'bg-red-100 text-red-600' : 'bg-gray-200'}`}><IconWrapper name="calculator" size={18}/></button>
                            </div>
                        </div>
                        <div className="flex space-x-1 overflow-x-auto pb-2" style={{scrollbarWidth:'none'}}>
                            <button onClick={() => setView('transactions')} className={`flex-1 py-2 px-4 rounded-lg text-sm font-bold whitespace-nowrap ${view === 'transactions' ? 'bg-red-100 text-red-800' : 'text-gray-500 hover:bg-gray-50'}`}>Fluxo</button>
                            <button onClick={() => setView('cards')} className={`flex-1 py-2 px-4 rounded-lg text-sm font-bold whitespace-nowrap ${view === 'cards' ? 'bg-purple-100 text-purple-800' : 'text-gray-500 hover:bg-gray-50'}`}>Cart√µes</button>
                            <button onClick={() => setView('investments')} className={`flex-1 py-2 px-4 rounded-lg text-sm font-bold whitespace-nowrap ${view === 'investments' ? 'bg-teal-100 text-teal-800' : 'text-gray-500 hover:bg-gray-50'}`}>Invest.</button>
                            <button onClick={() => setView('debts')} className={`flex-1 py-2 px-4 rounded-lg text-sm font-bold whitespace-nowrap ${view === 'debts' ? 'bg-indigo-100 text-indigo-800' : 'text-gray-500 hover:bg-gray-50'}`}>D√≠vidas</button>
                            <button onClick={() => setView('assets')} className={`flex-1 py-2 px-4 rounded-lg text-sm font-bold whitespace-nowrap ${view === 'assets' ? 'bg-blue-100 text-blue-800' : 'text-gray-500 hover:bg-gray-50'}`}>Bens</button>
                            <button onClick={() => setView('loans')} className={`flex-1 py-2 px-4 rounded-lg text-sm font-bold whitespace-nowrap ${view === 'loans' ? 'bg-orange-100 text-orange-800' : 'text-gray-500 hover:bg-gray-50'}`}>Receber</button>
                        </div>
                    </div>

                    <div className="p-4 animate-fadeIn">
                        {view === 'statement' && (
                            <div className="bg-white p-6 rounded-xl shadow-lg">
                                <div className="flex justify-between items-center mb-6 border-b pb-4">
                                    <h2 className="text-lg font-bold text-gray-800 flex items-center gap-2"><IconWrapper name="file-text" className="text-red-800"/> Extrato</h2>
                                </div>
                                <div className="mb-6 bg-green-50 p-4 rounded-lg border border-green-200">
                                    <p className="text-sm text-green-800 font-bold uppercase">Total Pago</p>
                                    <p className="text-3xl font-bold text-green-700">R$ {financialEntries.filter(e => e.status === 'paid' && e.type === 'expense').reduce((acc, curr) => acc + curr.value, 0).toFixed(2)}</p>
                                </div>
                                <div className="space-y-2">
                                    {financialEntries.filter(e => e.status === 'paid' && e.type === 'expense').sort((a,b) => new Date(b.date) - new Date(a.date)).map(entry => (
                                        <div key={entry.id} className="flex justify-between p-3 bg-gray-50 rounded border-b border-gray-100">
                                            <div>
                                                <div className="text-sm font-bold text-gray-800">{entry.desc}</div>
                                                <div className="text-xs text-gray-500">{new Date(entry.date).toLocaleDateString('pt-BR')} ‚Ä¢ {entry.category}</div>
                                            </div>
                                            <div className="font-bold text-red-600">- R$ {entry.value.toFixed(2)}</div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {view === 'settings' && (
                            <div className="space-y-6">
                                <div className="bg-white p-6 rounded-xl shadow border border-gray-100 text-center">
                                    <div className="mb-4 text-gray-600"><IconWrapper name="lock" size={48} className="mx-auto text-gray-400"/></div>
                                    <h3 className="font-bold text-xl text-gray-800 mb-6">Seguran√ßa</h3>
                                    {appPassword ? (
                                        <div className="bg-green-50 p-4 rounded-lg border border-green-200">
                                            <p className="text-green-700 font-bold mb-4">‚úì Prote√ß√£o Ativa</p>
                                            <button onClick={handleRemovePassword} className="w-full bg-red-500 text-white py-2 rounded font-bold hover:bg-red-600">Remover Senha</button>
                                        </div>
                                    ) : (
                                        <div className="space-y-4">
                                            <input type="password" placeholder="Nova Senha (m√≠n. 4)" className="w-full p-3 border rounded-lg text-center text-lg tracking-widest bg-gray-50" value={newPasswordInput} onChange={(e) => setNewPasswordInput(e.target.value)} inputMode="numeric"/>
                                            <button onClick={handleSetPassword} className="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700">Ativar Prote√ß√£o</button>
                                        </div>
                                    )}
                                    {financialEntries.filter(e => e.hidden).length > 0 && (
                                        <div className="bg-orange-50 p-4 rounded-lg border border-orange-200 mt-6 text-left">
                                            <h4 className="font-bold text-orange-800 mb-2 flex items-center gap-2"><IconWrapper name="trash-2" size={16}/> Hist√≥rico Oculto</h4>
                                            <p className="text-sm text-orange-700 mb-3">Existem <strong>{financialEntries.filter(e => e.hidden).length}</strong> itens ocultos somando no Saldo.</p>
                                            <ul className="mt-3 space-y-2 max-h-60 overflow-y-auto mb-4">
                                                {financialEntries.filter(e => e.hidden).map(entry => (
                                                    <li key={entry.id} className="flex justify-between items-center bg-white p-2 rounded border border-orange-100 shadow-sm">
                                                        <div><div className="font-bold text-gray-700 text-xs">{entry.desc}</div><div className="text-[10px] text-gray-500">R$ {entry.value.toFixed(2)}</div></div>
                                                        <button onClick={() => deleteHiddenItem(entry.id)} className="text-red-500 text-xs font-bold px-2 py-1 border border-red-200 rounded bg-red-50">Apagar</button>
                                                    </li>
                                                ))}
                                            </ul>
                                            <button onClick={clearHiddenItems} className="w-full bg-orange-600 text-white py-2 rounded font-bold hover:bg-orange-700 text-sm">Limpar Tudo Definitivamente</button>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {view === 'transactions' && (
                            <div className="space-y-6">
                                <div className="grid grid-cols-3 gap-2 text-center">
                                    <div className="bg-green-100 p-3 rounded-xl border border-green-200">
                                        <div className="text-[10px] font-bold text-green-700 uppercase tracking-wide">Entradas</div>
                                        <div className="text-sm font-bold text-green-800">R$ {summary.income.toFixed(2)}</div>
                                    </div>
                                    <div className="bg-red-100 p-3 rounded-xl border border-red-200">
                                        <div className="text-[10px] font-bold text-red-700 uppercase tracking-wide">Sa√≠das</div>
                                        <div className="text-sm font-bold text-red-800">R$ {summary.expense.toFixed(2)}</div>
                                    </div>
                                    <div className={`p-3 rounded-xl border-l-4 shadow-sm bg-white ${summary.balance >= 0 ? 'border-green-500' : 'border-red-500'}`}>
                                        <div className="text-[10px] font-bold text-gray-500 uppercase tracking-wide">Saldo</div>
                                        <div className={`text-sm font-bold ${summary.balance >= 0 ? 'text-gray-800' : 'text-red-600'}`}>R$ {summary.balance.toFixed(2)}</div>
                                    </div>
                                </div>
                                {summary.pendingExpense > 0 && <div className="bg-yellow-50 p-2 rounded border border-yellow-200 text-center text-xs text-yellow-700 font-bold">A Pagar (Pendente): R$ {summary.pendingExpense.toFixed(2)}</div>}

                                <div className="bg-white p-4 rounded-xl shadow border border-gray-100">
                                    <h3 className="font-bold text-gray-700 mb-3 text-sm flex justify-between items-center">{editingId ? 'Editar' : 'Nova Movimenta√ß√£o'}{editingId && <button onClick={cancelEdit} className="text-xs text-red-500 underline">Cancelar</button>}</h3>
                                    <div className="space-y-3">
                                        <div className="grid grid-cols-2 gap-3"><input type="date" className="w-full p-2 border rounded text-sm bg-gray-50" value={finForm.date} onChange={e => setFinForm({...finForm, date: e.target.value})} /><input type="number" placeholder="Valor (R$)" className="w-full p-2 border rounded text-sm bg-gray-50" value={finForm.value} onChange={e => setFinForm({...finForm, value: e.target.value})} /></div>
                                        <input type="text" placeholder="Descri√ß√£o" className="w-full p-2 border rounded text-sm bg-gray-50" value={finForm.desc} onChange={e => setFinForm({...finForm, desc: e.target.value})} />
                                        <div className="grid grid-cols-2 gap-3">
                                            <select className="w-full p-2 border rounded text-sm bg-gray-50" value={finForm.category} onChange={e => setFinForm({...finForm, category: e.target.value})}><option>Outros</option><option>D√≠zimo</option><option>Oferta</option><option>Alimenta√ß√£o</option><option>Contas</option><option>Transporte</option><option>Sa√∫de</option><option>Lazer</option><option>Sal√°rio</option></select>
                                            <select className="w-full p-2 border rounded text-sm bg-gray-50" value={finForm.method} onChange={e => setFinForm({...finForm, method: e.target.value})}><option>Dinheiro</option><option>Cart√£o Cr√©dito</option><option>Cart√£o D√©bito</option><option>Pix</option><option>Carn√™/Boleto</option></select>
                                        </div>
                                        {finForm.method === 'Cart√£o Cr√©dito' && (
                                            <div className="bg-yellow-50 p-3 rounded space-y-2">
                                                <div className="flex items-center gap-2"><span className="text-xs font-bold text-yellow-800">Cart√£o:</span><select className="w-full p-1 border rounded text-sm" value={finForm.cardId} onChange={e => setFinForm({...finForm, cardId: e.target.value})}><option value="">Selecione...</option>{userCards.map(card => <option key={card.id} value={card.id}>{card.name}</option>)}</select></div>
                                                <div className="flex items-center gap-2"><span className="text-xs font-bold text-yellow-800">Parcelas:</span><input type="number" min="1" max="48" className="w-16 p-1 border rounded text-sm" value={finForm.installments} onChange={e => setFinForm({...finForm, installments: e.target.value})} /></div>
                                            </div>
                                        )}
                                        {finForm.method === 'Carn√™/Boleto' && !editingId && (<div className="bg-blue-50 p-3 rounded space-y-2"><div className="flex items-center gap-2"><span className="text-xs font-bold text-blue-800">Parcelas:</span><input type="number" min="1" max="48" className="w-16 p-1 border rounded text-sm" value={finForm.installments} onChange={e => setFinForm({...finForm, installments: e.target.value})} /></div></div>)}
                                        <div className="flex gap-2 pt-2">
                                            <button onClick={() => setFinForm({...finForm, type: 'income'})} className={`flex-1 py-3 rounded text-sm font-bold tracking-wide shadow-lg transition transform hover:scale-105 ${finForm.type === 'income' ? 'bg-emerald-500 hover:bg-emerald-400 text-white shadow-emerald-500/40' : 'bg-gray-100 text-gray-400'}`}>Receita</button>
                                            <button onClick={() => setFinForm({...finForm, type: 'expense'})} className={`flex-1 py-3 rounded text-sm font-bold tracking-wide shadow-lg transition transform hover:scale-105 ${finForm.type === 'expense' ? 'bg-rose-600 hover:bg-rose-500 text-white shadow-rose-600/40' : 'bg-gray-100 text-gray-400'}`}>Despesa</button>
                                        </div>
                                        <button onClick={handleAddEntry} className="w-full bg-gradient-to-r from-red-600 to-orange-600 hover:from-red-500 hover:to-orange-500 text-white py-4 rounded-lg font-bold shadow-lg shadow-red-500/40 mt-3 flex justify-center items-center gap-2 text-base tracking-wide transform hover:scale-[1.02] transition-all"><IconWrapper name={editingId ? 'edit-2' : 'plus'}/> {editingId ? 'ATUALIZAR' : 'ADICIONAR'}</button>
                                    </div>
                                </div>

                                <div className="bg-white rounded-xl shadow overflow-hidden">
                                    <div className="flex justify-between items-center bg-gray-50 px-4 py-2">
                                        <span className="font-bold text-xs text-gray-500 uppercase">Hist√≥rico</span>
                                        <div className="flex gap-2">
                                            <button onClick={() => setHistoryFilter('all')} className={`text-[10px] font-bold px-2 py-1 rounded ${historyFilter === 'all' ? 'bg-gray-200' : 'text-gray-400'}`}>Todos</button>
                                            <button onClick={() => setHistoryFilter('pending')} className={`text-[10px] font-bold px-2 py-1 rounded ${historyFilter === 'pending' ? 'bg-yellow-100 text-yellow-700' : 'text-gray-400'}`}>Pendentes</button>
                                            <button onClick={() => setHistoryFilter('paid')} className={`text-[10px] font-bold px-2 py-1 rounded ${historyFilter === 'paid' ? 'bg-green-100 text-green-700' : 'text-gray-400'}`}>Pagos</button>
                                        </div>
                                    </div>
                                    <ul className="divide-y divide-gray-100">
                                        {filteredEntries.length === 0 ? <li className="p-4 text-center text-gray-400 text-sm">Sem registos vis√≠veis.</li> : 
                                        filteredEntries.sort((a,b) => new Date(a.date) - new Date(b.date)).map(entry => (
                                            <li key={entry.id} className={`p-4 flex justify-between items-center ${entry.status === 'paid' ? 'bg-white opacity-75' : 'bg-white'}`}>
                                                <div className="flex-1">
                                                    <div className="flex items-center gap-2"><span className={`font-bold ${entry.status === 'paid' ? 'text-gray-500 line-through' : 'text-gray-800'}`}>{entry.desc}</span><span className="text-[10px] px-2 py-0.5 bg-gray-100 rounded text-gray-500">{entry.category}</span></div>
                                                    <div className="text-xs text-gray-400 mt-1 flex flex-wrap items-center gap-1">{new Date(entry.date).toLocaleDateString('pt-BR')} ‚Ä¢ {entry.method} {entry.method === 'Cart√£o Cr√©dito' && entry.cardId && (<span className="bg-purple-100 text-purple-700 px-1 rounded border border-purple-200 text-[10px]">{getCardName(entry.cardId)}</span>)} {isOverdue(entry.date) && entry.status !== 'paid' && entry.type === 'expense' && <span className="text-red-500 font-bold ml-1 bg-red-100 px-1 rounded">Vencido</span>}</div>
                                                </div>
                                                <div className="text-right flex flex-col items-end gap-2">
                                                    <div className={`font-bold ${entry.type === 'income' ? 'text-green-600' : 'text-red-600'} ${entry.status === 'pending' ? '' : 'opacity-50'}`}>{entry.type === 'income' ? '+' : '-'} {parseFloat(entry.value).toFixed(2)}</div>
                                                    <div className="flex gap-2">
                                                        <button onClick={() => handleEditEntry(entry)} className="w-8 h-8 flex items-center justify-center rounded-full border border-gray-200 text-gray-400 hover:bg-blue-50 hover:text-blue-500 transition-all"><IconWrapper name="edit-2" size={14}/></button>
                                                        <button onClick={() => toggleEntryStatus(entry.id)} className={`w-8 h-8 flex items-center justify-center rounded-full border transition-all ${entry.status === 'paid' ? 'bg-green-500 border-green-600 text-white' : 'bg-white border-gray-300 text-gray-300'}`}><IconWrapper name="check" size={16} /></button>
                                                        <button onClick={() => handleTrashClick(entry)} className="w-8 h-8 flex items-center justify-center rounded-full border border-gray-200 text-gray-300 hover:bg-red-50 hover:text-red-500 transition-all"><IconWrapper name="trash-2" size={14}/></button>
                                                    </div>
                                                </div>
                                            </li>
                                        ))}
                                    </ul>
                                </div>
                                <SimplePieChart data={chartData} onSliceClick={handlePieClick} />
                            </div>
                        )}

                        {view === 'cards' && (
                            <div className="space-y-6">
                                <div className="bg-white p-4 rounded-xl shadow"><h3 className="font-bold text-purple-700 mb-3 text-sm flex items-center gap-2"><IconWrapper name="credit-card"/> Novo Cart√£o</h3><div className="flex gap-2 mb-2"><input type="text" placeholder="Nome" className="flex-1 p-2 border rounded text-sm" value={cardForm.name} onChange={e => setCardForm({...cardForm, name: e.target.value})} /><input type="number" placeholder="Limite" className="w-24 p-2 border rounded text-sm" value={cardForm.limit} onChange={e => setCardForm({...cardForm, limit: e.target.value})} /><input type="number" placeholder="Dia Venc." min="1" max="31" className="w-20 p-2 border rounded text-sm" value={cardForm.dueDay} onChange={e => setCardForm({...cardForm, dueDay: e.target.value})} /></div><button onClick={handleAddCard} className="w-full bg-purple-600 text-white py-2 rounded font-bold hover:bg-purple-700">Adicionar Cart√£o</button></div>
                                <div className="space-y-4">{userCards.map(card => {
                                    const totalUsed = getTotalCardUsage(card.id); const currentInvoice = getCurrentInvoiceValue(card.id); const available = card.limit - totalUsed; const percentUsed = Math.min(100, (totalUsed / card.limit) * 100); const cardEntries = financialEntries.filter(e => e.cardId === card.id && e.status === 'pending').sort((a,b) => new Date(a.date) - new Date(b.date));
                                    return (
                                        <div key={card.id} className="bg-white rounded-xl shadow-lg overflow-hidden transition-all">
                                            <div onClick={() => toggleCardDetails(card.id)} className="bg-gradient-to-r from-gray-800 to-gray-700 p-5 text-white relative cursor-pointer hover:opacity-95">
                                                <div className="flex justify-between items-start mb-4"><div><h4 className="font-bold text-lg">{card.name}</h4><span className="text-xs text-gray-400">Vence dia {card.dueDay}</span></div><IconWrapper name="credit-card" className="text-gray-500 opacity-50" size={32}/></div>
                                                <div className="grid grid-cols-2 gap-4 text-sm mb-4"><div><div className="text-xs text-gray-400">Fatura Atual (M√™s)</div><div className="font-bold text-red-300">R$ {currentInvoice.toFixed(2)}</div></div><div className="text-right"><div className="text-xs text-gray-400">Dispon√≠vel</div><div className="font-bold text-green-300">R$ {available.toFixed(2)}</div></div></div>
                                                <div className="w-full bg-gray-600 h-2 rounded-full overflow-hidden mb-2"><div className={`h-full ${percentUsed > 90 ? 'bg-red-500' : 'bg-green-500'}`} style={{width: `${percentUsed}%`}}></div></div>
                                                <button onClick={(e) => { e.stopPropagation(); deleteItem(card.id, userCards, setUserCards); }} className="absolute top-2 right-2 text-gray-500 hover:text-red-400"><IconWrapper name="trash-2" size={16}/></button>
                                                <div className="text-center text-[10px] text-gray-400 mt-1">{expandedCardId === card.id ? '‚ñ≤ Ocultar Detalhes' : '‚ñº Ver Parcelas e Fatura'}</div>
                                            </div>
                                            {expandedCardId === card.id && (
                                                <div className="bg-gray-50 p-4 border-t border-gray-200 animate-fadeIn">
                                                    <h5 className="font-bold text-gray-500 text-xs uppercase mb-3">Parcelas a Vencer (Fatura Aberta e Futuras)</h5>
                                                    {cardEntries.length === 0 ? <p className="text-center text-sm text-gray-400">Nenhuma compra pendente neste cart√£o.</p> : 
                                                    <ul className="space-y-2">{cardEntries.map(entry => (<li key={entry.id} className="flex justify-between items-center bg-white p-3 rounded border border-gray-100 shadow-sm"><div><div className="font-bold text-gray-800 text-sm">{entry.desc}</div><div className="text-xs text-gray-500">{new Date(entry.date).toLocaleDateString('pt-BR')} ‚Ä¢ {entry.category}</div></div><div className="font-bold text-red-600 text-sm">R$ {entry.value.toFixed(2)}</div></li>))}</ul>}
                                                    <div className="mt-4 pt-2 border-t border-gray-200 text-right"><span className="text-xs font-bold text-gray-500 uppercase mr-2">Total Pendente:</span><span className="font-bold text-gray-800">R$ {cardEntries.reduce((acc, curr) => acc + curr.value, 0).toFixed(2)}</span></div>
                                                </div>
                                            )}
                                        </div>
                                    );
                                })}</div>
                            </div>
                        )}

                        {view === 'debts' && (
                            <div className="space-y-6">
                                <div className="bg-indigo-600 p-6 rounded-2xl shadow-lg text-white text-center"><div className="text-xs font-bold uppercase opacity-80 mb-1">Total D√≠vidas Longas</div><div className="text-3xl font-bold">R$ {userDebts.reduce((acc, curr) => acc + (curr.totalValue - (curr.totalValue/curr.installments * (getDebtProgress(curr.id).paid))), 0).toFixed(2)}</div></div>
                                <div className="bg-white p-4 rounded-xl shadow border border-indigo-100">
                                    <h3 className="font-bold text-gray-700 mb-3 text-sm flex items-center gap-2"><IconWrapper name="briefcase"/> Nova D√≠vida/Financiamento</h3>
                                    <div className="grid grid-cols-1 gap-3">
                                        <input type="text" placeholder="Nome (Ex: Casa)" className="w-full p-2 border rounded text-sm bg-gray-50" value={debtForm.name} onChange={e => setDebtForm({...debtForm, name: e.target.value})} />
                                        <div className="flex gap-2"><input type="number" placeholder="Valor Total" className="flex-1 p-2 border rounded text-sm" value={debtForm.totalValue} onChange={e => setDebtForm({...debtForm, totalValue: e.target.value})} /><input type="number" placeholder="Parcelas" className="w-24 p-2 border rounded text-sm" value={debtForm.installments} onChange={e => setDebtForm({...debtForm, installments: e.target.value})} /></div>
                                        <div className="flex gap-2"><div className="flex-1"><label className="block text-[10px] font-bold text-gray-400 mb-1">Dia Vencimento</label><input type="number" min="1" max="31" className="w-full p-2 border rounded text-sm bg-gray-50" value={debtForm.dueDay} onChange={e => setDebtForm({...debtForm, dueDay: e.target.value})} placeholder="Dia" /></div><div className="flex-1 flex items-end"><button onClick={handleAddDebt} className="w-full bg-indigo-600 text-white py-2 rounded font-bold hover:bg-indigo-700">Salvar</button></div></div>
                                    </div>
                                </div>
                                <div className="space-y-4">{userDebts.map(debt => {
                                    const { paid, total } = getDebtProgress(debt.id); const remaining = debt.totalValue - ((debt.totalValue/debt.installments) * paid); const progress = (paid / debt.installments) * 100;
                                    return (
                                        <div key={debt.id} className="bg-white rounded-xl shadow-lg overflow-hidden border-l-4 border-indigo-500">
                                            <div className="p-4">
                                                <div className="flex justify-between items-start mb-2"><h4 className="font-bold text-indigo-900 text-lg">{debt.name}</h4><button onClick={() => deleteDebt(debt.id)} className="text-gray-400 hover:text-red-500"><IconWrapper name="trash-2" size={16}/></button></div>
                                                <div className="flex justify-between text-xs text-gray-500 mb-2"><span>Pago: {paid}/{debt.installments}</span><span>Restante: R$ {remaining.toFixed(2)}</span></div>
                                                <div className="w-full bg-gray-200 h-3 rounded-full overflow-hidden mb-3"><div className="h-full bg-indigo-500 transition-all duration-500" style={{width: `${progress}%`}}></div></div>
                                                <p className="text-[10px] text-center text-gray-400">Gerencie as parcelas na aba FLUXO.</p>
                                            </div>
                                        </div>
                                    );
                                })}</div>
                            </div>
                        )}

                        {view === 'investments' && (
                            <div className="space-y-6">
                                <div className="bg-teal-600 p-6 rounded-2xl shadow-lg text-white text-center"><div className="text-xs font-bold uppercase opacity-80 mb-1">Total Investido</div><div className="text-3xl font-bold">R$ {userInvestments.reduce((acc, curr) => acc + curr.value, 0).toFixed(2)}</div></div>
                                <div className="bg-white p-4 rounded-xl shadow"><h3 className="font-bold text-gray-700 mb-3 text-sm">Adicionar Investimento</h3><div className="flex flex-col gap-3"><div className="flex gap-2"><select className="w-1/3 p-2 border rounded text-sm bg-gray-50" value={investmentForm.type} onChange={e => setInvestmentForm({...investmentForm, type: e.target.value})}><option>Poupan√ßa</option><option>CDB</option><option>A√ß√µes</option><option>Fundos</option><option>Outros</option></select><input type="text" placeholder="Nome" className="flex-1 p-2 border rounded text-sm" value={investmentForm.name} onChange={e => setInvestmentForm({...investmentForm, name: e.target.value})} /></div><div className="flex gap-2"><input type="number" placeholder="Valor (R$)" className="flex-1 p-2 border rounded text-sm" value={investmentForm.value} onChange={e => setInvestmentForm({...investmentForm, value: e.target.value})} /><button onClick={handleAddInvestment} className="w-24 bg-teal-600 text-white py-2 rounded font-bold hover:bg-teal-700">Salvar</button></div></div></div>
                                <div className="space-y-3">{userInvestments.map(inv => (<div key={inv.id} className="bg-white p-4 rounded-xl shadow border-l-4 border-teal-500 flex justify-between items-center"><div><span className="text-[10px] font-bold text-teal-600 bg-teal-50 px-2 py-0.5 rounded uppercase">{inv.type}</span><div className="font-bold text-gray-800 mt-1">{inv.name}</div></div><div className="flex items-center gap-3"><span className="font-bold text-teal-700">R$ {inv.value.toFixed(2)}</span><button onClick={() => deleteItem(inv.id, userInvestments, setUserInvestments)} className="text-gray-400 hover:text-red-500"><IconWrapper name="trash-2" size={16}/></button></div></div>))}</div>
                            </div>
                        )}

                        {view === 'assets' && (
                            <div className="space-y-6">
                                <div className="bg-blue-600 p-6 rounded-2xl shadow-lg text-white text-center"><div className="text-xs font-bold uppercase opacity-80 mb-1">Patrim√≥nio Total</div><div className="text-3xl font-bold">R$ {userAssets.reduce((acc, curr) => acc + curr.value, 0).toFixed(2)}</div></div>
                                <div className="bg-white p-4 rounded-xl shadow"><h3 className="font-bold text-gray-700 mb-3 text-sm">Adicionar Bem</h3><div className="flex gap-2 mb-2"><input type="text" placeholder="Nome" className="flex-1 p-2 border rounded text-sm" value={assetForm.name} onChange={e => setAssetForm({...assetForm, name: e.target.value})} /><input type="number" placeholder="Valor" className="w-24 p-2 border rounded text-sm" value={assetForm.value} onChange={e => setAssetForm({...assetForm, value: e.target.value})} /></div><button onClick={handleAddAsset} className="w-full bg-blue-600 text-white py-2 rounded font-bold hover:bg-blue-700">Salvar Bem</button></div>
                                <div className="grid grid-cols-1 gap-3">{userAssets.map(asset => (<div key={asset.id} className="bg-white p-4 rounded-xl shadow flex justify-between items-center border-l-4 border-blue-500"><span className="font-bold text-gray-800">{asset.name}</span><div className="flex items-center gap-3"><span className="font-bold text-blue-600">R$ {asset.value.toFixed(2)}</span><button onClick={() => deleteItem(asset.id, userAssets, setUserAssets)} className="text-gray-400 hover:text-red-500"><IconWrapper name="trash-2" size={16}/></button></div></div>))}</div>
                            </div>
                        )}

                        {view === 'loans' && (
                            <div className="space-y-6">
                                <div className="bg-orange-500 p-6 rounded-2xl shadow-lg text-white text-center"><div className="text-xs font-bold uppercase opacity-80 mb-1">Total a Receber</div><div className="text-3xl font-bold">R$ {userLoans.reduce((acc, curr) => acc + curr.value, 0).toFixed(2)}</div></div>
                                <div className="bg-white p-4 rounded-xl shadow"><h3 className="font-bold text-gray-700 mb-3 text-sm">Registar D√≠vida</h3><input type="text" placeholder="Quem deve?" className="w-full p-2 border rounded text-sm mb-2" value={loanForm.name} onChange={e => setLoanForm({...loanForm, name: e.target.value})} /><div className="flex gap-2 mb-2"><input type="number" placeholder="Valor" className="flex-1 p-2 border rounded text-sm" value={loanForm.value} onChange={e => setLoanForm({...loanForm, value: e.target.value})} /><input type="date" className="w-32 p-2 border rounded text-sm" value={loanForm.date} onChange={e => setLoanForm({...loanForm, date: e.target.value})} /></div><input type="text" placeholder="Motivo" className="w-full p-2 border rounded text-sm mb-3" value={loanForm.desc} onChange={e => setLoanForm({...loanForm, desc: e.target.value})} /><button onClick={handleAddLoan} className="w-full bg-orange-500 text-white py-2 rounded font-bold hover:bg-orange-600">Adicionar</button></div>
                                <div className="space-y-3">{userLoans.map(loan => (<div key={loan.id} className="bg-white p-4 rounded-xl shadow border-l-4 border-orange-400"><div className="flex justify-between items-start mb-1"><h4 className="font-bold text-gray-800">{loan.name}</h4><span className="font-bold text-orange-600">R$ {loan.value.toFixed(2)}</span></div><p className="text-sm text-gray-600">{loan.desc}</p><div className="flex justify-between items-center mt-2 pt-2 border-t border-gray-100"><span className="text-xs text-gray-400">Previsto: {loan.date ? new Date(loan.date).toLocaleDateString('pt-BR') : 'Sem data'}</span><button onClick={() => deleteLoan(loan.id)} className="text-red-400 hover:text-red-600 text-xs font-bold flex items-center gap-1"><IconWrapper name="trash-2" size={12}/> Apagar</button></div></div>))}</div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- SISTEMA PRINCIPAL ISOLADO ---
        const MainSystem = ({ activeTab, setActiveTab }) => {
            const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
            
            // Estados B√≠blia e Jogos
            const [selectedBook, setSelectedBook] = usePersistentState('lastBook', 'G√™nesis');
            const [selectedChapter, setSelectedChapter] = usePersistentState('lastChapter', 1);
            const [chapterContent, setChapterContent] = useState(null);
            const [loadingBible, setLoadingBible] = useState(false);
            const [sermon, setSermon] = useState(null);
            const [isSpeaking, setIsSpeaking] = useState(false);
            const [highlights, setHighlights] = usePersistentState('bibleHighlights', {});
            
            // Estados Recuperados (Features Completas)
            const [diaryEntries, setDiaryEntries] = usePersistentState('diary', {});
            const [currentDate, setCurrentDate] = useState(new Date());
            const [inputName, setInputName] = useState('');
            const [nameResult, setNameResult] = useState(null);
            const [isPlayingRadio, setIsPlayingRadio] = useState(false);
            const audioRef = useRef(null);
            
            // Estados QR Code
            const [qrUrl, setQrUrl] = usePersistentState('qrUrl', '');
            const [qrPixKey, setQrPixKey] = usePersistentState('qrPixKey', '');
            const [qrPixName, setQrPixName] = usePersistentState('qrPixName', '');
            const [qrPixCity, setQrPixCity] = usePersistentState('qrPixCity', '');
            const [qrPixAmount, setQrPixAmount] = usePersistentState('qrPixAmount', '');
            const qrCodeRef = useRef(null);

            const fetchChapter = async (book, chapter) => {
                setLoadingBible(true);
                try {
                    const response = await fetch(`https://bible-api.com/${encodeURIComponent(book)}+${chapter}?translation=almeida`);
                    const data = await response.json();
                    setChapterContent(data.verses);
                } catch { setChapterContent([{ verse: 1, text: "Erro na liga√ß√£o." }]); }
                finally { setLoadingBible(false); }
            };
            
            useEffect(() => { if(activeTab === 'bible') fetchChapter(selectedBook, selectedChapter); }, [selectedBook, selectedChapter, activeTab]);

            // Fun√ß√µes de √Åudio (B√≠blia)
            const toggleNarrator = () => {
                if (isSpeaking) { window.speechSynthesis.cancel(); setIsSpeaking(false); }
                else {
                    if (!chapterContent) return;
                    setIsSpeaking(true);
                    const text = chapterContent.map(v => v.text).join(' ');
                    const utterance = new SpeechSynthesisUtterance(text);
                    utter.onend = () => setIsSpeaking(false);
                    window.speechSynthesis.speak(utter);
                }
            };

            // Fun√ß√µes QR Code e PIX
            const gerarQR = (text) => {
                if(!qrCodeRef.current) return;
                qrCodeRef.current.innerHTML = '';
                new QRCode(qrCodeRef.current, { text, width: 200, height: 200, colorDark: "#000000", colorLight: "#ffffff", correctLevel: QRCode.CorrectLevel.H });
            };

            const handleGerarPix = () => {
                if (!qrPixKey || !qrPixName || !qrPixCity) return alert("Preencha a chave, nome e cidade.");
                const info = [window.formatarEMV('00', 'br.gov.bcb.pix'), window.formatarEMV('01', qrPixKey)].join('');
                let brCode = [window.formatarEMV('00', '01'), window.formatarEMV('26', info), window.formatarEMV('52', '0000'), window.formatarEMV('53', '986')];
                if(qrPixAmount) brCode.push(window.formatarEMV('54', parseFloat(qrPixAmount).toFixed(2)));
                brCode.push(window.formatarEMV('58', 'BR'), window.formatarEMV('59', window.simplificarTexto(qrPixName).substring(0,25)), window.formatarEMV('60', window.simplificarTexto(qrPixCity).substring(0,15)), window.formatarEMV('62', window.formatarEMV('05', '***')), '6304');
                const stringPIX = brCode.join('');
                gerarQR(stringPIX + window.crc16(stringPIX));
            };

            const BackButton = () => (
                <button onClick={() => setActiveTab('home')} className="mb-4 flex items-center gap-2 text-red-800 font-bold hover:underline">
                    <IconWrapper name="arrow-left" size={20} /> Voltar ao In√≠cio
                </button>
            );

            const formatDateKey = (date) => date.toISOString().split('T')[0];

            return (
                <div className="min-h-screen flex flex-col font-inter bg-gray-50">
                    <header className="bg-red-800 text-white shadow-lg sticky top-0 z-50 no-print">
                        <div className="container mx-auto px-4 py-4 flex justify-between items-center">
                            <div className="flex items-center gap-3 cursor-pointer" onClick={() => setActiveTab('home')}>
                                <IconWrapper name="book-open" className="text-yellow-400" size={32} />
                                <div><h1 className="text-xl font-bold">Sistema Vida</h1><p className="text-xs opacity-75">Alimento Di√°rio</p></div>
                            </div>
                            <nav className="hidden xl:flex gap-4 text-sm font-medium">
                                {NAV_ITEMS.map(item => (
                                    <button key={item.id} onClick={() => setActiveTab(item.id)} className={`hover:text-yellow-300 transition-all ${activeTab === item.id ? 'text-yellow-400 font-bold underline' : ''}`}>{item.label}</button>
                                ))}
                            </nav>
                            <button className="xl:hidden" onClick={() => setMobileMenuOpen(!mobileMenuOpen)}><IconWrapper name="menu" /></button>
                        </div>
                        {mobileMenuOpen && (
                            <div className="xl:hidden bg-red-900 p-4 grid grid-cols-2 gap-2 border-t border-red-700 animate-fadeIn">
                                {NAV_ITEMS.map(item => (
                                    <button key={item.id} onClick={() => {setActiveTab(item.id); setMobileMenuOpen(false)}} className="text-left p-2 flex items-center gap-2 text-sm">
                                        <IconWrapper name={item.icon} size={16} /> {item.label}
                                    </button>
                                ))}
                            </div>
                        )}
                    </header>

                    <main className="flex-grow container mx-auto px-4 py-8">
                        {activeTab === 'home' && (
                            <div className="space-y-8 animate-fadeIn">
                                <div className="bg-gradient-to-r from-red-800 to-red-600 rounded-2xl shadow-xl p-8 text-white text-center">
                                    <h2 className="text-2xl font-serif mb-4 animate-bounce-subtle">"O Senhor √© o meu pastor, nada me faltar√°."</h2>
                                    <button onClick={() => setActiveTab('bible')} className="bg-white text-red-800 px-8 py-2 rounded-full font-bold shadow hover:bg-gray-100 transition-all">Abrir a B√≠blia</button>
                                </div>
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    <div onClick={()=>setActiveTab('studio')} className="bg-gradient-to-br from-indigo-500 to-purple-600 text-white p-6 rounded-xl shadow-lg text-center cursor-pointer hover:scale-105 transition-transform border border-transparent">
                                        <div className="w-12 h-12 mx-auto rounded-full flex items-center justify-center bg-white/20 mb-3"><i className="fas fa-magic text-2xl"></i></div>
                                        <h3 className="font-bold">Criador de Cards</h3>
                                        <p className="text-[10px] opacity-80 uppercase mt-1">Clean Edition</p>
                                    </div>

                                    {NAV_ITEMS.filter(i => i.id !== 'home' && i.id !== 'studio').map(i => (
                                        <div key={i.id} onClick={()=>setActiveTab(i.id)} className="bg-white p-6 rounded-xl shadow text-center cursor-pointer hover:scale-105 transition-transform border border-gray-100">
                                            <div className="w-12 h-12 mx-auto rounded-full flex items-center justify-center bg-red-100 text-red-800 mb-3"><IconWrapper name={i.icon} /></div>
                                            <h3 className="font-bold text-gray-700">{i.label}</h3>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {activeTab === 'bible' && (
                            <div className="bg-white rounded-xl shadow-lg flex flex-col md:flex-row h-[75vh] overflow-hidden animate-fadeIn">
                                <div className="w-full md:w-64 bg-gray-50 border-r p-4 overflow-y-auto">
                                    <BackButton />
                                    <select value={selectedBook} onChange={e=>setSelectedBook(e.target.value)} className="w-full p-2 mb-4 border rounded shadow-sm font-bold text-red-900">{bibleBooks.map(b=><option key={b}>{b}</option>)}</select>
                                    <div className="grid grid-cols-5 gap-1">
                                        {[...Array(150)].map((_,i)=><button key={i} onClick={()=>setSelectedChapter(i+1)} className={`p-2 text-xs rounded transition-colors ${selectedChapter===i+1?'bg-red-800 text-white':'bg-gray-200'}`}>{i+1}</button>)}
                                    </div>
                                </div>
                                <div className="flex-1 p-8 overflow-y-auto font-serif text-lg leading-relaxed relative">
                                    <div className="flex justify-between items-center mb-6 pb-2 border-b">
                                        <h2 className="text-2xl font-bold text-red-900">{selectedBook} {selectedChapter}</h2>
                                        <button onClick={toggleNarrator} title="Ouvir cap√≠tulo" className={`p-2 rounded shadow-sm border ${isSpeaking?'bg-red-100 text-red-600 border-red-200':'bg-white text-gray-400 hover:text-red-800'}`}><IconWrapper name={isSpeaking?'square':'volume-2'} size={20}/></button>
                                    </div>
                                    {loadingBible ? <p className="text-center text-gray-400 animate-pulse">Consultando as escrituras...</p> : chapterContent?.map(v=>(
                                        <p key={v.verse} onClick={()=> {
                                            const key = `${selectedBook}-${selectedChapter}-${v.verse}`;
                                            setHighlights(p => ({...p, [key]: p[key] ? null : '#fef08a'}));
                                        }} className="mb-2 cursor-pointer p-1 rounded transition-colors hover:bg-gray-50" style={{ backgroundColor: highlights[`${selectedBook}-${selectedChapter}-${v.verse}`] }}>
                                            <span className="text-red-700 font-bold text-xs mr-2 select-none">{v.verse}</span>{v.text}
                                        </p>
                                    ))}
                                </div>
                            </div>
                        )}

                        {activeTab === 'games' && (
                            <div className="max-w-4xl mx-auto bg-white p-8 rounded-2xl shadow animate-fadeIn text-center">
                                <BackButton />
                                <h2 className="text-2xl font-bold mb-8 text-gray-800">Sala de Jogos</h2>
                                <div className="grid md:grid-cols-3 gap-6">
                                    <div className="p-8 border-2 border-yellow-200 rounded-xl hover:bg-yellow-50 cursor-pointer">
                                        <div className="text-4xl mb-4">üìñ</div><h3 className="font-bold">Quiz B√≠blico</h3>
                                    </div>
                                    <div className="p-8 border-2 border-blue-200 rounded-xl hover:bg-blue-50 cursor-pointer">
                                        <div className="text-4xl mb-4">üê∂</div><h3 className="font-bold">Mem√≥ria</h3>
                                    </div>
                                    <div className="p-8 border-2 border-green-200 rounded-xl hover:bg-green-50 cursor-pointer">
                                        <div className="text-4xl mb-4">‚öì</div><h3 className="font-bold">Forca</h3>
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'radio' && (
                            <div className="text-center p-12 bg-gray-900 text-white rounded-3xl animate-fadeIn">
                                <BackButton />
                                <div className="mb-12"><IconWrapper name="radio" size={100} className="text-yellow-400 mx-auto animate-pulse" /></div>
                                <h2 className="text-3xl font-bold mb-3">R√°dio Gospel</h2>
                                <div className="flex justify-center items-end gap-1 mb-12 h-16">{isPlayingRadio ? [...Array(6)].map((_,i)=><div key={i} className="sound-bar" style={{animationDuration: `${0.4 + Math.random()}s`, width: '8px'}}></div>) : <div className="h-1 w-40 bg-gray-800 rounded-full"></div>}</div>
                                <button onClick={()=>{if(isPlayingRadio) audioRef.current.pause(); else audioRef.current.play(); setIsPlayingRadio(!isPlayingRadio);}} className={`w-24 h-24 rounded-full flex items-center justify-center mx-auto shadow-xl transition-all transform hover:scale-110 active:scale-95 ${isPlayingRadio?'bg-yellow-400 text-gray-900':'bg-red-600 text-white'}`}><IconWrapper name={isPlayingRadio ? 'square' : 'radio'} size={45} /></button>
                                <audio ref={audioRef} src="https://live.hunter.fm/gospel_stream?ag=mp3" crossOrigin="anonymous"></audio>
                            </div>
                        )}
                        
                        {activeTab === 'preaching' && (
                            <div className="max-w-2xl mx-auto bg-white p-8 rounded-2xl shadow animate-fadeIn">
                                <BackButton />
                                <h2 className="text-2xl font-bold text-center mb-6 text-red-800">Gerador de Prega√ß√£o</h2>
                                <button onClick={()=>setSermon(preachingDatabase[Math.floor(Math.random()*preachingDatabase.length)])} className="w-full bg-red-800 text-white py-3 rounded-xl font-bold mb-6">Gerar Esbo√ßo</button>
                                {sermon && <div className="bg-gray-50 p-6 rounded-xl border border-gray-200"><h3 className="font-bold text-xl mb-2">{sermon.theme}</h3><p className="text-sm font-bold text-gray-500 uppercase mb-4">{sermon.ref}</p><div className="space-y-2">{sermon.points.map((p,i)=><p key={i}>‚Ä¢ {p}</p>)}</div></div>}
                            </div>
                        )}
                        
                        {activeTab === 'qrcode' && (
                            <div className="max-w-4xl mx-auto space-y-6 animate-fadeIn">
                                <BackButton />
                                <div className="bg-white p-6 rounded-2xl shadow border-t-4 border-green-600 space-y-4">
                                    <h3 className="font-bold flex items-center gap-2 text-green-800"><IconWrapper name="qr-code" size={18}/> Pagamento PIX (Brasil)</h3>
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-2">
                                        <input type="text" value={qrPixKey} onChange={e=>setQrPixKey(e.target.value)} placeholder="Chave" className="p-2 border rounded text-xs" />
                                        <input type="text" value={qrPixName} onChange={e=>setQrPixName(e.target.value)} placeholder="Nome" className="p-2 border rounded text-xs" />
                                        <input type="text" value={qrPixCity} onChange={e=>setQrPixCity(e.target.value)} placeholder="Cidade" className="p-2 border rounded text-xs" />
                                        <input type="number" value={qrPixAmount} onChange={e=>setQrPixAmount(e.target.value)} placeholder="Valor" className="p-2 border rounded text-xs" />
                                    </div>
                                    <button onClick={handleGerarPix} className="w-full bg-green-700 text-white py-3 rounded-xl font-bold hover:bg-green-800 shadow-md">Criar C√≥digo PIX</button>
                                </div>
                                <div className="bg-white p-6 rounded-2xl shadow border-t-4 border-red-800 space-y-4">
                                    <h3 className="font-bold flex items-center gap-2 text-red-800"><IconWrapper name="book-open" size={18}/> Link Web</h3>
                                    <input type="text" value={qrUrl} onChange={e=>setQrUrl(e.target.value)} placeholder="https://..." className="w-full p-3 border rounded" />
                                    <button onClick={()=>gerarQR(qrUrl)} className="w-full bg-red-800 text-white py-3 rounded-xl font-bold">Criar C√≥digo</button>
                                </div>
                                <div className="bg-white p-12 rounded-3xl shadow-xl flex flex-col items-center border border-gray-50"><div ref={qrCodeRef}></div></div>
                            </div>
                        )}

                        {activeTab === 'names' && (
                            <div className="text-center p-8 bg-white rounded-xl shadow animate-fadeIn">
                                <BackButton />
                                <h2 className="text-xl font-bold mb-4">Significado de Nomes</h2>
                                <div className="flex gap-2 justify-center">
                                    <input type="text" value={inputName} onChange={(e)=>setInputName(e.target.value)} placeholder="Digite um nome..." className="p-2 border rounded" />
                                    <button onClick={()=>{const res = nameDatabase[inputName.toLowerCase().trim()]; setNameResult(res || "Nome aben√ßoado.");}} className="bg-red-800 text-white px-4 rounded">Ver</button>
                                </div>
                                {nameResult && <p className="mt-4 font-bold text-lg text-red-800">{nameResult}</p>}
                            </div>
                        )}

                        {activeTab === 'notes' && (
                            <div className="bg-white p-10 rounded-[3rem] shadow-2xl space-y-8 border border-gray-100 relative animate-fadeIn">
                                <BackButton />
                                <div className="flex justify-between items-center bg-gray-50 p-6 rounded-[2rem]">
                                    <button onClick={()=>{const d=new Date(currentDate); d.setDate(d.getDate()-1); setCurrentDate(d);}} className="p-3 border rounded-full bg-white"><IconWrapper name="chevron-left" size={24}/></button>
                                    <h3 className="font-bold text-red-900 text-xl">{currentDate.toLocaleDateString('pt-PT')}</h3>
                                    <button onClick={()=>{const d=new Date(currentDate); d.setDate(d.getDate()+1); setCurrentDate(d);}} className="p-3 border rounded-full bg-white"><IconWrapper name="chevron-right" size={24}/></button>
                                </div>
                                <textarea 
                                    value={diaryEntries[formatDateKey(currentDate)] || ""} 
                                    onChange={(e)=>setDiaryEntries({...diaryEntries, [formatDateKey(currentDate)]: e.target.value})}
                                    className="w-full h-[300px] p-10 border border-gray-100 rounded-[2.5rem] font-handwriting text-2xl outline-none resize-none shadow-inner bg-[#fdfdfd]" 
                                    placeholder="Querido Di√°rio..."
                                ></textarea>
                            </div>
                        )}

                        {activeTab === 'financial' && (
                            <div className="animate-fadeIn">
                                <BackButton />
                                <FinancialTab />
                            </div>
                        )}

                    </main>

                    <footer className="bg-gray-900 text-gray-400 py-8 text-center border-t border-gray-800 mt-auto no-print">
                        <p className="font-bold text-white mb-2">Sistema Vida Completo</p>
                        <p className="text-xs opacity-50">Integra√ß√£o v31.1</p>
                    </footer>
                </div>
            );
        };

        // --- APP PRINCIPAL ---
        function App() {
            const [activeTab, setActiveTab] = useState('home');

            if (activeTab === 'studio') {
                return <CardStudio key="studio" onExit={() => setActiveTab('home')} />;
            }

            return <MainSystem key="main" activeTab={activeTab} setActiveTab={setActiveTab} />;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
